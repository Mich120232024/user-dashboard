<!DOCTYPE html>
<html>
<head>
    <title>Debug Graph Loading</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        #graph-container { width: 100%; height: 500px; border: 2px solid #333; }
        .log { margin: 5px 0; padding: 5px; background: #f0f0f0; }
        .error { background: #ffe0e0; color: red; }
        .success { background: #e0ffe0; color: green; }
    </style>
    <script src="https://unpkg.com/cytoscape@3.26.0/dist/cytoscape.min.js"></script>
</head>
<body>
    <h1>Debug Graph Loading</h1>
    <button onclick="debugLoadGraph()">Test Load Graph</button>
    <div id="logs"></div>
    <div id="graph-container"></div>

    <script>
        const API_BASE = 'http://localhost:8420/api/v1';
        
        function log(message, type = 'log') {
            const logsDiv = document.getElementById('logs');
            const logEntry = document.createElement('div');
            logEntry.className = `log ${type}`;
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logsDiv.appendChild(logEntry);
            console.log(message);
        }
        
        async function fetchData(url) {
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return await response.json();
            } catch (error) {
                console.error(`Failed to fetch ${url}:`, error);
                return null;
            }
        }
        
        async function debugLoadGraph() {
            const container = document.getElementById('graph-container');
            
            log('Starting graph load...');
            container.innerHTML = '<div class="loading">Loading graph data...</div>';
            
            try {
                log('Fetching data from: ' + `${API_BASE}/graph/data`);
                const data = await fetchData(`${API_BASE}/graph/data`);
                
                log('Data received: ' + JSON.stringify(data ? {nodes: data.nodes?.length, edges: data.edges?.length} : null));
                
                if (data && data.nodes && data.edges) {
                    log('Data structure valid, initializing Cytoscape...');
                    
                    // Clear container
                    container.innerHTML = '';
                    
                    const cy = cytoscape({
                        container: container,
                        
                        style: [
                            {
                                selector: 'node',
                                style: {
                                    'background-color': '#1f2937',
                                    'label': 'data(label)',
                                    'text-valign': 'center',
                                    'text-halign': 'center',
                                    'color': '#e5e7eb',
                                    'font-size': '12px',
                                    'border-width': 2,
                                    'border-color': '#374151',
                                    'width': 60,
                                    'height': 60
                                }
                            },
                            {
                                selector: 'node[category="leadership"]',
                                style: {
                                    'background-color': '#3b82f6',
                                    'border-color': '#2563eb',
                                    'width': 80,
                                    'height': 80,
                                    'font-size': '14px',
                                    'font-weight': 'bold'
                                }
                            },
                            {
                                selector: 'edge',
                                style: {
                                    'width': 2,
                                    'line-color': '#4b5563',
                                    'target-arrow-color': '#4b5563',
                                    'target-arrow-shape': 'triangle',
                                    'curve-style': 'bezier',
                                    'label': 'data(label)',
                                    'font-size': '10px',
                                    'color': '#9ca3af'
                                }
                            }
                        ],
                        
                        elements: {
                            nodes: data.nodes,
                            edges: data.edges
                        },
                        
                        layout: {
                            name: 'breadthfirst',
                            directed: true,
                            padding: 30,
                            spacingFactor: 1.5,
                            roots: '#BUSINESS_OWNER'
                        },
                        
                        minZoom: 0.5,
                        maxZoom: 3,
                        wheelSensitivity: 0.2
                    });
                    
                    log('Cytoscape initialized', 'success');
                    
                    cy.on('tap', 'node', function(evt) {
                        const node = evt.target;
                        log('Node clicked: ' + node.id());
                    });
                    
                    cy.fit();
                    log('Graph fitted to viewport', 'success');
                    
                } else {
                    log('Invalid data structure', 'error');
                    container.innerHTML = '<div class="empty-state">No graph data available</div>';
                }
            } catch (error) {
                log('Error: ' + error.message, 'error');
                container.innerHTML = '<div class="error">Error loading graph: ' + error.message + '</div>';
            }
        }
    </script>
</body>
</html>