<!DOCTYPE html>
<html>
<head>
    <title>Test Mailbox API</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-result { margin: 10px 0; padding: 10px; border: 1px solid #ccc; }
        .success { background: #e8f5e9; }
        .error { background: #ffebee; }
        .debug { background: #f3e5f5; font-family: monospace; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>Mailbox API Test</h1>
    <div id="results"></div>
    <button onclick="runTest()">Run Test</button>
    
    <script>
        const API_BASE = 'http://localhost:8001/api/v1';
        
        function addResult(className, content) {
            const div = document.createElement('div');
            div.className = `test-result ${className}`;
            div.innerHTML = content;
            document.getElementById('results').appendChild(div);
        }
        
        async function runTest() {
            document.getElementById('results').innerHTML = '';
            
            try {
                addResult('', 'Testing fetchDataCached function...');
                
                // Simulate the fetchDataCached function from dashboard
                const fetchDataCached = async (url, skipCache = false) => {
                    try {
                        const response = await fetch(url);
                        if (!response.ok) throw new Error(`HTTP ${response.status}`);
                        const data = await response.json();
                        return data;
                    } catch (error) {
                        console.error(`Failed to fetch ${url}:`, error);
                        return null;
                    }
                };
                
                // Test the exact same call as refreshMessages
                const data = await fetchDataCached(`${API_BASE}/messages/HEAD_OF_ENGINEERING?limit=5`, true);
                
                addResult('debug', `Raw API Response:\n${JSON.stringify(data, null, 2)}`);
                
                if (data && data.messages && Array.isArray(data.messages)) {
                    addResult('success', `✅ SUCCESS: Found ${data.messages.length} messages`);
                    addResult('debug', `First message preview:\n${JSON.stringify(data.messages[0], null, 2)}`);
                } else {
                    addResult('error', `❌ FAILED: data.messages check failed`);
                    addResult('debug', `data exists: ${!!data}\ndata.messages exists: ${!!(data && data.messages)}\ndata.messages is array: ${!!(data && data.messages && Array.isArray(data.messages))}`);
                }
                
            } catch (error) {
                addResult('error', `❌ ERROR: ${error.message}`);
            }
        }
        
        // Auto-run on load
        runTest();
    </script>
</body>
</html>