<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modal ESC Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-btn { padding: 10px 20px; margin: 10px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .status { margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>Safari Modal ESC Key Test</h1>
    <button class="test-btn" onclick="showTestModal()">Open Test Modal</button>
    <div class="status" id="status">Ready to test...</div>
    
    <h3>Instructions:</h3>
    <ol>
        <li>Click "Open Test Modal" button</li>
        <li>Try pressing ESC key to close modal</li>
        <li>If ESC doesn't work, click outside modal content to close</li>
        <li>Check console for debug messages</li>
    </ol>

    <script>
        let currentModal = null;
        
        // Enhanced global ESC handler (same as dashboard)
        document.addEventListener('keydown', function(e) {
            console.log('Global ESC pressed:', e.key, e.keyCode, e.which, 'Modal exists:', !!currentModal);
            
            // Multiple Safari compatibility checks
            const isEscape = e.key === 'Escape' || e.keyCode === 27 || e.which === 27;
            
            if (isEscape && currentModal) {
                console.log('ESC detected, preventing default and closing modal');
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation();
                
                closeTestModal();
                updateStatus('✅ ESC key worked! Modal closed successfully.');
                return false;
            }
        }, true);
        
        function showTestModal() {
            updateStatus('Opening test modal...');
            
            // Create modal with same structure as dashboard
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.7); z-index: 1000; display: flex; 
                align-items: center; justify-content: center; cursor: pointer;
            `;
            
            modal.innerHTML = `
                <div class="modal-content" style="background: white; border-radius: 8px; width: 500px; max-height: 80vh; 
                            border: 1px solid #ccc; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: default; padding: 20px;">
                    <h3>Test Modal</h3>
                    <p>This modal tests Safari ESC key functionality.</p>
                    <p><strong>Try:</strong></p>
                    <ul>
                        <li>Press ESC key to close</li>
                        <li>Click outside this content area</li>
                        <li>Click the X button</li>
                    </ul>
                    <button onclick="closeTestModal()" style="padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        ✕ Close
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
            currentModal = modal;
            
            // Enhanced Safari modal setup
            modal.setAttribute('tabindex', '-1');
            modal.setAttribute('role', 'dialog');
            modal.setAttribute('aria-modal', 'true');
            
            // Force focus in Safari-compatible way
            setTimeout(() => {
                modal.focus();
                console.log('Modal focused after timeout');
                updateStatus('Modal opened. Try ESC key or click outside...');
            }, 10);
            
            // Enhanced click outside handler
            modal.addEventListener('click', function(e) {
                console.log('Modal click - target:', e.target.tagName, 'currentTarget:', e.currentTarget.tagName);
                if (e.target === modal || e.target === e.currentTarget) {
                    console.log('Clicked on modal background, closing...');
                    e.preventDefault();
                    e.stopPropagation();
                    closeTestModal();
                    updateStatus('✅ Click outside worked! Modal closed successfully.');
                }
            }, false);
            
            // Prevent clicks on modal content from bubbling
            const modalContent = modal.querySelector('.modal-content');
            if (modalContent) {
                modalContent.addEventListener('click', function(e) {
                    console.log('Clicked on modal content, preventing bubble');
                    e.stopPropagation();
                }, false);
            }
        }
        
        function closeTestModal() {
            if (currentModal) {
                document.body.removeChild(currentModal);
                currentModal = null;
                console.log('Test modal closed');
            }
        }
        
        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }
        
        // Make functions global for onclick handlers
        window.showTestModal = showTestModal;
        window.closeTestModal = closeTestModal;
    </script>
</body>
</html>