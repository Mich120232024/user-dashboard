<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Research & Analytics Command Center</title>
    <link rel="icon" type="image/svg+xml" href="./favicon.ico">
    
    <!-- Scripts removed for debugging -->
    
    <!-- Lightweight dashboard - no external dependencies -->
    <script>
        console.log('Dashboard loading with native JavaScript only');
    </script>
    <style>
        :root {
            --primary-dark: #0a0e27;
            --primary-blue: #1e3a8a;
            --accent-blue: #3b82f6;
            --accent-cyan: #06b6d4;
            --success-green: #10b981;
            --warning-amber: #f59e0b;
            --danger-red: #ef4444;
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --bg-hover: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border-color: #334155;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.3);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.4);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.5);
            --gradient-primary: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            --gradient-dark: linear-gradient(180deg, #0a0e27 0%, #1e293b 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* Professional Header */
        .header {
            background: var(--gradient-dark);
            border-bottom: 1px solid var(--border-color);
            padding: 1.5rem 2rem;
            box-shadow: var(--shadow-md);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--gradient-primary);
        }

        .header-content {
            max-width: 1800px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo {
            width: 40px;
            height: 40px;
            background: var(--gradient-primary);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.5rem;
            box-shadow: var(--shadow-sm);
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
            letter-spacing: -0.02em;
            background: linear-gradient(135deg, #f1f5f9 0%, #94a3b8 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-stats {
            display: flex;
            gap: 2rem;
            align-items: center;
        }

        .stat-item {
            text-align: right;
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .stat-value {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--accent-cyan);
        }

        /* Navigation Tabs */
        .nav-container {
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-sm);
        }

        .nav-tabs {
            max-width: 1800px;
            margin: 0 auto;
            display: flex;
            gap: 0;
            padding: 0 0.5rem;
        }

        .nav-tab {
            padding: 1rem 1.5rem;
            background: transparent;
            color: var(--text-secondary);
            border: none;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            position: relative;
            transition: all 0.2s ease;
            border-bottom: 2px solid transparent;
        }

        .nav-tab:hover {
            color: var(--text-primary);
            background: var(--bg-hover);
        }

        .nav-tab.active {
            color: var(--accent-cyan);
            border-bottom-color: var(--accent-cyan);
            background: rgba(6, 182, 212, 0.1);
        }

        .nav-tab-icon {
            margin-right: 0.5rem;
        }

        /* Main Content Area */
        .main-container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 1.5rem 0.5rem;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Card Components */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.25rem;
            margin-bottom: 1rem;
            box-shadow: var(--shadow-sm);
            transition: all 0.2s ease;
        }

        .card:hover {
            box-shadow: var(--shadow-md);
            border-color: var(--accent-blue);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border-color);
        }

        .card-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-badge {
            background: var(--gradient-primary);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        /* Memory Layer Cards */
        .memory-layer {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 1rem;
            overflow: hidden;
            transition: all 0.2s ease;
        }

        .layer-1 {
            border-color: var(--danger-red);
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.05) 0%, transparent 100%);
        }

        .layer-2 {
            border-color: var(--warning-amber);
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.05) 0%, transparent 100%);
        }

        .layer-3 {
            border-color: var(--success-green);
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.05) 0%, transparent 100%);
        }

        .memory-layer-header {
            padding: 1rem 1.25rem;
            background: rgba(0, 0, 0, 0.2);
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            user-select: none;
        }

        .memory-layer-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .layer-lock-icon {
            font-size: 0.875rem;
            opacity: 0.7;
        }

        .memory-layer-meta {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
            margin-top: 0.75rem;
        }

        .meta-item {
            display: flex;
            flex-direction: column;
        }

        .meta-label {
            font-size: 0.6875rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.125rem;
        }

        .meta-value {
            font-size: 0.75rem;
            color: var(--text-primary);
            font-weight: 500;
            line-height: 1.2;
        }

        .memory-layer-content {
            padding: 1rem 1.25rem;
            display: none;
        }

        .memory-layer-content.expanded {
            display: block;
        }

        .code-block {
            background: var(--bg-dark);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 0.75rem;
            font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
            font-size: 0.75rem;
            overflow-x: auto;
            margin: 0.75rem 0;
            line-height: 1.4;
        }

        .code-block pre {
            margin: 0;
            color: var(--text-secondary);
        }

        /* Buttons */
        .btn {
            padding: 0.625rem 1.25rem;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
            box-shadow: var(--shadow-sm);
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-secondary {
            background: var(--bg-hover);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--border-color);
        }

        .btn-danger {
            background: var(--danger-red);
            color: white;
        }

        .btn-success {
            background: var(--success-green);
            color: white;
        }

        /* Grid Layouts */
        .grid {
            display: grid;
            gap: 1rem;
        }

        .grid-2 {
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
        }

        .grid-3 {
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        }

        /* Status Indicators */
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.375rem 0.75rem;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .status-online {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success-green);
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .status-offline {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger-red);
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .status-warning {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning-amber);
            border: 1px solid rgba(245, 158, 11, 0.2);
        }

        /* Pulse Animation */
        .pulse {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(0.8); }
            100% { opacity: 1; transform: scale(1); }
        }

        /* Loading State */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 3rem;
            color: var(--text-muted);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-cyan);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }
            
            .nav-tabs {
                overflow-x: auto;
                padding: 0 1rem;
            }
            
            .grid-2, .grid-3 {
                grid-template-columns: 1fr;
            }
            
            .main-container {
                padding: 1rem;
            }
        }
        
        /* Document Viewer Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            backdrop-filter: blur(4px);
        }
        
        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            width: 90%;
            height: 85%;
            max-width: 1200px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
        }
        
        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        
        .modal-header h3 {
            margin: 0;
            font-size: 1.25rem;
            color: var(--text-primary);
        }
        
        .modal-close {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 4px;
            transition: all 0.2s;
        }
        
        .modal-close:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }
        
        .modal-body {
            flex: 1;
            overflow: auto;
            padding: 1.5rem;
        }
        
        .document-viewer {
            background: var(--bg-dark);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.9rem;
            line-height: 1.6;
            color: var(--text-primary);
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        /* Enhanced Document Viewer Styles */
        .document-viewer-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            gap: 1rem;
        }
        
        .document-meta-enhanced {
            background: var(--bg-hover);
            border-radius: 8px;
            padding: 1rem;
            flex-shrink: 0;
        }
        
        .meta-section h4 {
            margin: 0 0 1rem 0;
            color: var(--text-primary);
            font-size: 1rem;
        }
        
        .meta-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.75rem;
        }
        
        .meta-item {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        
        .meta-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
        }
        
        .meta-value {
            color: var(--text-primary);
            font-family: monospace;
            font-size: 0.875rem;
            word-break: break-all;
        }
        
        .content-tabs {
            display: flex;
            background: var(--bg-hover);
            border-radius: 8px;
            padding: 0.25rem;
            gap: 0.25rem;
            flex-shrink: 0;
        }
        
        .content-tab {
            flex: 1;
            padding: 0.75rem 1rem;
            background: transparent;
            border: none;
            border-radius: 6px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }
        
        .content-tab:hover {
            background: var(--bg-card);
            color: var(--text-primary);
        }
        
        .content-tab.active {
            background: var(--accent-cyan);
            color: white;
        }
        
        .content-panels {
            flex: 1;
            overflow: hidden;
            position: relative;
        }
        
        .content-panel {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow: auto;
            padding: 1rem;
            background: var(--bg-card);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            opacity: 1;
            visibility: visible;
            transition: all 0.2s;
        }
        
        .content-panel.active {
            opacity: 1;
            visibility: visible;
        }
        
        .content-section {
            margin-bottom: 2rem;
        }
        
        .content-header {
            margin: 0 0 1rem 0;
            color: var(--text-primary);
            font-size: 1.1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--border-color);
        }
        
        .content-text {
            background: var(--bg-dark);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 1.5rem;
            font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
            font-size: 0.9rem;
            line-height: 1.6;
            color: var(--text-primary);
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 60vh;
            overflow: auto;
        }
        
        .json-viewer {
            background: var(--bg-dark);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 1rem;
            font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
            font-size: 0.85rem;
            line-height: 1.4;
            color: var(--text-primary);
            max-height: 70vh;
            overflow: auto;
        }
        
        .json-viewer pre {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .document-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: var(--bg-dark);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        
        .document-meta-item {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        
        .document-meta-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .document-meta-value {
            font-size: 0.9rem;
            color: var(--text-primary);
            font-weight: 500;
        }
        
        .view-document-btn {
            background: var(--accent-blue);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s;
            margin-top: 0.5rem;
        }
        
        .view-document-btn:hover {
            background: var(--primary-blue);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
    </style>
</head>
<body>
    <!-- Professional Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo-section">
                <div class="logo">R&A</div>
                <h1>Research & Analytics Command Center</h1>
            </div>
            <div class="header-stats">
                <div class="stat-item">
                    <div class="stat-label">System Status</div>
                    <div class="stat-value">
                        <span id="header-system-status" class="status-indicator status-online">
                            <span class="pulse"></span>
                            Loading...
                        </span>
                    </div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Active Agents</div>
                    <div id="header-active-agents" class="stat-value">0/0</div>
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="nav-container">
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('overview')">
                <span class="nav-tab-icon">üìä</span>Overview
            </button>
            <button class="nav-tab" onclick="switchTab('memory')">
                <span class="nav-tab-icon">üß†</span>Memory Layers
            </button>
            <button class="nav-tab" onclick="switchTab('agents')">
                <span class="nav-tab-icon">ü§ñ</span>Agent Management
            </button>
            <button class="nav-tab" onclick="switchTab('cosmos')">
                <span class="nav-tab-icon">üåê</span>Cosmos DB
            </button>
            <button class="nav-tab" onclick="switchTab('monitoring')">
                <span class="nav-tab-icon">üìà</span>Monitoring
            </button>
            <button class="nav-tab" onclick="switchTab('graph')">
                <span class="nav-tab-icon">üï∏Ô∏è</span>Graph Explorer
            </button>
            <button class="nav-tab" onclick="switchTab('docs')">
                <span class="nav-tab-icon">üìö</span>Documentation
            </button>
            <button class="nav-tab" onclick="switchTab('settings')">
                <span class="nav-tab-icon">‚öôÔ∏è</span>Settings
            </button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-container">
        <!-- Overview Tab -->
        <div id="overview-tab" class="tab-content active">
            <div class="grid grid-3">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <span>üè¢</span>System Health
                        </h3>
                        <span class="card-badge">Live</span>
                    </div>
                    <div id="system-health-overview" class="grid" style="gap: 0.75rem;">
                        <div class="meta-item">
                            <span class="meta-label">Cosmos DB</span>
                            <span id="cosmos-status" class="meta-value status-indicator status-online">
                                <span class="pulse"></span>Connected
                            </span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">System Inbox</span>
                            <span id="inbox-count" class="meta-value">25</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">Total Items</span>
                            <span id="total-items" class="meta-value">1,247</span>
                        </div>
                    </div>
                </div>


                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <span>üë•</span>Active Agents
                        </h3>
                        <span class="card-badge">Live</span>
                    </div>
                    <div id="agents-list-content">
                        <div class="meta-item">
                            <span class="meta-label">4 Active Agents</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <span>üöÄ</span>Quick Actions
                    </h3>
                </div>
                <div class="grid grid-3" style="gap: 1rem;">
                    <button class="btn btn-primary" onclick="runHealthCheck()">
                        <span>üè•</span>Run Health Check
                    </button>
                    <button class="btn btn-primary" onclick="checkMessages()">
                        <span>üì¨</span>Check System Inbox
                    </button>
                    <button class="btn btn-primary" onclick="viewAgents()">
                        <span>üë•</span>View Agent Status
                    </button>
                    <button class="btn btn-secondary" onclick="openDocument('system_architecture')">
                        <span>üß†</span>Memory Architecture
                    </button>
                    <button class="btn btn-secondary" onclick="openDocument('messaging_guide')">
                        <span>üì®</span>Messaging Guide
                    </button>
                    <button class="btn btn-secondary" onclick="openDocument('implementation_status')">
                        <span>‚úÖ</span>Implementation Status
                    </button>
                </div>
            </div>

            <!-- Core Documents -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <span>üìö</span>Core Documents
                    </h3>
                    <span class="card-badge">Essential</span>
                </div>
                <div id="core-documents-content">
                    <div class="meta-item">
                        <span class="meta-label">1,247 Documents</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Memory Layers Tab -->
        <div id="memory-tab" class="tab-content">
            <div class="card" style="margin-bottom: 2rem;">
                <div class="card-header">
                    <h3 class="card-title">
                        <span>üß†</span>3-Layer Memory Architecture
                    </h3>
                    <button class="btn btn-primary" onclick="validateMemoryStructure()">
                        Validate Structure
                    </button>
                </div>
                <p style="color: var(--text-secondary); line-height: 1.8;">
                    Hierarchical memory system ensuring system integrity through immutable core rules,
                    controlled identity management, and flexible working memory.
                </p>
            </div>

            <!-- Layer 1: Reptilian Core -->
            <div class="memory-layer layer-1">
                <div class="memory-layer-header" onclick="toggleLayer('layer1')">
                    <div class="memory-layer-title">
                        <span>
                            <span style="color: var(--danger-red);">üî¥</span>
                            Layer 1: REPTILIAN CORE (System Hardcoded)
                        </span>
                        <span class="layer-lock-icon">üîí</span>
                    </div>
                    <div class="memory-layer-meta">
                        <div class="meta-item">
                            <span class="meta-label">Owner</span>
                            <span class="meta-value">HEAD_OF_ENGINEERING</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">Mutability</span>
                            <span class="meta-value">IMMUTABLE</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">Agent Access</span>
                            <span class="meta-value">READ ONLY</span>
                        </div>
                    </div>
                </div>
                <div id="layer1-content" class="memory-layer-content">
                    <div class="code-block">
                        <pre id="layer1-yaml"># REPTILIAN_CORE.yaml
# ‚ö†Ô∏è DO NOT MODIFY - CONTACT HEAD_OF_ENGINEERING

survival_rules:
  evidence_based_operation:
    rule: "Every claim requires evidence"
    violation_consequence: "Immediate correction required"</pre>
                    </div>
                    <div style="background: rgba(239, 68, 68, 0.1); padding: 0.75rem; border-radius: 6px; margin-top: 0.75rem; font-size: 0.8125rem;">
                        <strong style="color: var(--danger-red);">‚ö†Ô∏è CRITICAL WARNING</strong><br>
                        This layer is FORBIDDEN for agent updates. Any modification attempts will be logged.
                        Contact HEAD_OF_ENGINEERING for any issues.
                    </div>
                </div>
            </div>

            <!-- Layer 2: Identity -->
            <div class="memory-layer layer-2">
                <div class="memory-layer-header" onclick="toggleLayer('layer2')">
                    <div class="memory-layer-title">
                        <span>
                            <span style="color: var(--warning-amber);">üü°</span>
                            Layer 2: IDENTITY LAYER (Restricted Updates)
                        </span>
                        <span class="layer-lock-icon">üîê</span>
                    </div>
                    <div class="memory-layer-meta">
                        <div class="meta-item">
                            <span class="meta-label">Owner</span>
                            <span class="meta-value">HEAD_OF_ENGINEERING + Head of Research</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">Mutability</span>
                            <span class="meta-value">RESTRICTED</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">Agent Access</span>
                            <span class="meta-value">READ ONLY</span>
                        </div>
                    </div>
                </div>
                <div id="layer2-content" class="memory-layer-content">
                    <div class="code-block">
                        <pre id="layer2-yaml"># IDENTITY_LAYER.yaml
# üîê RESTRICTED ACCESS - DUAL AUTHORIZATION REQUIRED

agent_identity:
  name: "HEAD_OF_ENGINEERING"
  role: "System Architecture & Database Management"
  clearance_level: "ADMIN"</pre>
                    </div>
                    <div style="background: rgba(245, 158, 11, 0.1); padding: 0.75rem; border-radius: 6px; margin-top: 0.75rem; font-size: 0.8125rem;">
                        <strong style="color: var(--warning-amber);">üîê RESTRICTED ACCESS</strong><br>
                        Modifications require dual authorization. Submit requests through System Inbox.
                    </div>
                </div>
            </div>

            <!-- Layer 3: Working Context -->
            <div class="memory-layer layer-3">
                <div class="memory-layer-header" onclick="toggleLayer('layer3')">
                    <div class="memory-layer-title">
                        <span>
                            <span style="color: var(--success-green);">üü¢</span>
                            Layer 3: WORKING CONTEXT (Agent Dynamic)
                        </span>
                        <span class="layer-lock-icon">‚úèÔ∏è</span>
                    </div>
                    <div class="memory-layer-meta">
                        <div class="meta-item">
                            <span class="meta-label">Owner</span>
                            <span class="meta-value">Individual Agent</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">Mutability</span>
                            <span class="meta-value">FULLY DYNAMIC</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">Agent Access</span>
                            <span class="meta-value">READ/WRITE</span>
                        </div>
                    </div>
                </div>
                <div id="layer3-content" class="memory-layer-content">
                    <div class="code-block">
                        <pre id="layer3-yaml"># WORKING_CONTEXT.yaml
# ‚úÖ AGENT CONTROLLED - Update freely within schema

current_session:
  timestamp: "2025-06-20T21:30:00Z"
  active_task: "Dashboard implementation"
  priority_queue: ["Memory structure", "Professional styling"]</pre>
                    </div>
                    <div style="background: rgba(16, 185, 129, 0.1); padding: 0.75rem; border-radius: 6px; margin-top: 0.75rem; font-size: 0.8125rem;">
                        <strong style="color: var(--success-green);">‚úÖ AGENT CONTROLLED</strong><br>
                        Update freely within schema constraints. Changes auto-saved to Cosmos DB.
                    </div>
                </div>
            </div>
        </div>

        <!-- Agents Tab -->
        <div id="agents-tab" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <span>ü§ñ</span>Agent Management Console
                    </h3>
                    <button class="btn btn-primary" onclick="refreshAgents()">
                        Refresh Status
                    </button>
                </div>
                <div id="detailed-agents-content" class="grid grid-2">
                    <div class="loading">
                        <div class="spinner"></div>
                        <span style="margin-left: 1rem;">4 Active Agents</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cosmos DB Tab -->
        <div id="cosmos-tab" class="tab-content">
            <div class="grid grid-2">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <span>üåê</span>Database Overview
                        </h3>
                        <span class="card-badge">Live</span>
                    </div>
                    <div id="cosmos-overview-content">
                        <div class="loading">
                            <div class="spinner"></div>
                            <span style="margin-left: 1rem;">Ready</span>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <span>üìä</span>Container Statistics
                        </h3>
                    </div>
                    <div id="cosmos-containers-content">
                        <div class="loading">
                            <div class="spinner"></div>
                            <span style="margin-left: 1rem;">Ready</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <span>üîç</span>Database Explorer
                    </h3>
                </div>
                <div style="padding: 1rem; background: var(--bg-dark); border-radius: 6px; margin: 1rem 0;">
                    <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                        <select id="container-select" style="padding: 0.5rem; background: var(--bg-card); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 4px;">
                            <option>Select Container...</option>
                        </select>
                        <button class="btn btn-primary" onclick="loadContainerData()">Load Data</button>
                    </div>
                    <div id="container-data-content" style="max-height: 400px; overflow-y: auto;"></div>
                </div>
            </div>
        </div>

        <!-- Monitoring Tab -->
        <div id="monitoring-tab" class="tab-content">
            <div class="grid grid-3">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <span>üè•</span>System Health
                        </h3>
                        <span class="card-badge">Live</span>
                    </div>
                    <div id="system-health-content">
                        <div class="loading">
                            <div class="spinner"></div>
                            <span style="margin-left: 1rem;">Checking health...</span>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <span>üìà</span>Performance Metrics
                        </h3>
                    </div>
                    <div id="performance-metrics" class="grid" style="gap: 0.75rem;">
                        <div class="meta-item">
                            <span class="meta-label">Containers</span>
                            <span id="container-count" class="meta-value">8</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">Storage Size</span>
                            <span id="storage-size" class="meta-value">1,247 documents</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">RU Usage</span>
                            <span id="ru-usage" class="meta-value">research</span>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <span>üîÑ</span>Quick Actions
                        </h3>
                    </div>
                    <div class="grid" style="gap: 0.5rem;">
                        <button class="btn btn-primary" onclick="runSystemCheck()">
                            <span>üîç</span>System Check
                        </button>
                        <button class="btn btn-secondary" onclick="exportLogs()">
                            <span>üìÑ</span>Export Logs
                        </button>
                        <button class="btn btn-secondary" onclick="clearCache()">
                            <span>üóëÔ∏è</span>Clear Cache
                        </button>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <span>üîß</span>Server Management
                        </h3>
                        <span class="card-badge" style="background: var(--warning-amber);">Admin</span>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 1rem;">
                        <div class="meta-item">
                            <span class="meta-label">Server Status</span>
                            <span id="server-status" class="meta-value status-indicator status-online">
                                <span class="pulse"></span>Running
                            </span>
                        </div>
                        
                        <div style="border-top: 1px solid var(--border-color); padding-top: 1rem;">
                            <h4 style="color: var(--text-secondary); font-size: 0.875rem; margin-bottom: 0.75rem;">Quick Actions:</h4>
                            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                <button class="btn btn-primary" onclick="restartServer()">
                                    <span>üîÑ</span>Restart Server
                                </button>
                                <button class="btn btn-secondary" onclick="reloadFrontend()">
                                    <span>üåê</span>Reload Frontend
                                </button>
                                <button class="btn btn-secondary" onclick="clearServerCache()">
                                    <span>üßπ</span>Clear Server Cache
                                </button>
                            </div>
                        </div>
                        
                        <div style="font-size: 0.75rem; color: var(--text-muted); padding: 0.5rem; background: var(--bg-dark); border-radius: 4px;">
                            <strong>‚ö†Ô∏è Note:</strong> Server restart will briefly interrupt all dashboard functions. Use when applying updates or fixing issues.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Graph Explorer Tab -->
        <div id="graph-tab" class="tab-content">
            <div style="display: flex; gap: 1rem; height: calc(100vh - 200px);">
                <!-- Graph Visualization Panel (Left - 70%) -->
                <div class="card" style="flex: 1; display: flex; flex-direction: column;">
                    <div class="card-header">
                        <h3 class="card-title">
                            <span>üï∏Ô∏è</span>Knowledge Graph Visualization
                        </h3>
                        <div class="card-controls" style="display: flex; gap: 1rem; align-items: center;">
                            <select id="graph-layout" onchange="changeGraphLayout()" style="padding: 0.5rem; background: var(--bg-dark); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 4px;">
                                <option value="circle">Circle Layout</option>
                                <option value="grid">Grid Layout</option>
                                <option value="breadthfirst">Hierarchical</option>
                                <option value="concentric">Concentric</option>
                                <option value="cose-bilkent">Physics Layout</option>
                            </select>
                            <button class="btn btn-primary" onclick="refreshGraph()">üîÑ Refresh</button>
                            <button class="btn btn-secondary" onclick="resetGraphView()">üéØ Reset View</button>
                        </div>
                    </div>
                    <div style="position: relative; flex: 1;">
                        <div id="graph-container" style="width: 100%; height: 100%; background: var(--bg-dark); border: 1px solid var(--border-color); border-radius: 8px; position: relative;"></div>
                        <div id="graph-loading" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: var(--text-muted); display: none;">
                            <div class="spinner" style="margin: 0 auto 1rem;"></div>
                            <div>Graph Ready - 1,247 nodes</div>
                        </div>
                    </div>
                </div>

                <!-- Side Panel (Right - 30%) -->
                <div style="width: 350px; display: flex; flex-direction: column; gap: 1rem;">
                    <!-- Graph Controls Panel -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <span>üéõÔ∏è</span>Controls
                            </h3>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 1rem;">
                            <!-- Domain Filter -->
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary); font-size: 0.875rem;">Filter by Domain:</label>
                                <select id="domain-filter" onchange="filterByDomain()" style="width: 100%; padding: 0.5rem; background: var(--bg-dark); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 4px;">
                                    <option value="">All Domains</option>
                                    <option value="artificial_intelligence">AI Research (6 nodes)</option>
                                    <option value="data_science">Data Science (5 nodes)</option>
                                    <option value="cloud_computing">Cloud Computing (4 nodes)</option>
                                </select>
                            </div>

                            <!-- Node Type Filter -->
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary); font-size: 0.875rem;">Show Node Types:</label>
                                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem; color: var(--text-primary); font-size: 0.875rem;">
                                        <input type="checkbox" id="show-documents" checked onchange="toggleNodeType('ResearchDocument')">
                                        üìÑ Documents
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; color: var(--text-primary); font-size: 0.875rem;">
                                        <input type="checkbox" id="show-concepts" checked onchange="toggleNodeType('ResearchConcept')">
                                        üí° Concepts
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; color: var(--text-primary); font-size: 0.875rem;">
                                        <input type="checkbox" id="show-authors" checked onchange="toggleNodeType('Author')">
                                        üë§ Authors
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; color: var(--text-primary); font-size: 0.875rem;">
                                        <input type="checkbox" id="show-methods" checked onchange="toggleNodeType('Methodology')">
                                        üî¨ Methods
                                    </label>
                                </div>
                            </div>

                            <!-- Search -->
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary); font-size: 0.875rem;">Search Nodes:</label>
                                <input type="text" id="node-search" placeholder="Search by name or ID..." onkeyup="searchNodes()" style="width: 100%; padding: 0.5rem; background: var(--bg-dark); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 4px;">
                            </div>
                        </div>
                    </div>

                    <!-- Graph Stats -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <span>üìä</span>Statistics
                            </h3>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 0.5rem; font-size: 0.875rem;">
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--text-secondary);">Nodes:</span>
                                <span id="node-count" style="color: var(--text-primary); font-weight: 600;">0</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--text-secondary);">Edges:</span>
                                <span id="edge-count" style="color: var(--text-primary); font-weight: 600;">0</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--text-secondary);">Selected:</span>
                                <span id="selected-count" style="color: var(--accent-cyan); font-weight: 600;">None</span>
                            </div>
                        </div>
                    </div>

                    <!-- Node Details Panel -->
                    <div class="card" style="flex: 1;">
                        <div class="card-header">
                            <h3 class="card-title">
                                <span>üîç</span>Node Inspector
                            </h3>
                        </div>
                        <div id="node-details" style="font-size: 0.875rem; overflow-y: auto;">
                            <div style="text-align: center; padding: 2rem; color: var(--text-muted);">
                                Click on a node to view details
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Documentation Tab -->
        <div id="docs-tab" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <span>üìö</span>Documentation Browser
                    </h3>
                    <div style="display: flex; gap: 1rem;">
                        <input type="text" id="docs-search" placeholder="Search documentation..." style="padding: 0.5rem; background: var(--bg-dark); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 4px; min-width: 200px;">
                        <button class="btn btn-primary" onclick="searchDocs()">Search</button>
                    </div>
                </div>
                <div id="docs-browser-content">
                    <div class="loading">
                        <div class="spinner"></div>
                        <span style="margin-left: 1rem;">Documentation Ready</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settings-tab" class="tab-content">
            <div class="grid grid-2">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <span>‚öôÔ∏è</span>System Configuration
                        </h3>
                    </div>
                    <div class="grid" style="gap: 1rem;">
                        <div class="meta-item">
                            <span class="meta-label">Database</span>
                            <span id="config-database" class="meta-value">research-analytics-db</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">Environment</span>
                            <span id="config-environment" class="meta-value">Production</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">Total Storage</span>
                            <span id="config-storage" class="meta-value">Azure Cosmos DB</span>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <span>üîê</span>Security Settings
                        </h3>
                    </div>
                    <div class="grid" style="gap: 1rem;">
                        <div class="meta-item">
                            <span class="meta-label">Authentication</span>
                            <span class="meta-value status-indicator status-online">
                                <span class="pulse"></span>Active
                            </span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">SSL/TLS</span>
                            <span class="meta-value status-indicator status-online">
                                <span class="pulse"></span>Enabled
                            </span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">Access Control</span>
                            <span class="meta-value">Role-based</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <span>üîß</span>Maintenance Actions
                    </h3>
                </div>
                <div class="grid grid-3" style="gap: 1rem;">
                    <button class="btn btn-secondary" onclick="backupSystem()">
                        <span>üíæ</span>Backup System
                    </button>
                    <button class="btn btn-secondary" onclick="validateConfig()">
                        <span>‚úÖ</span>Validate Config
                    </button>
                    <button class="btn btn-danger" onclick="restartServices()">
                        <span>üîÑ</span>Restart Services
                    </button>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <span>üìú</span>Session Log Upload
                    </h3>
                    <span class="card-badge">Local + Cosmos DB</span>
                </div>
                <div style="padding: 1rem;">
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; font-weight: 500; color: var(--text-primary); margin-bottom: 0.5rem;">Select Agent:</label>
                        <select id="agent-selector" style="width: 100%; padding: 0.75rem; background: var(--bg-dark); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.875rem;">
                            <option value="">Select agent for log...</option>
                            <option value="HEAD_OF_ENGINEERING">Head of Engineering</option>
                            <option value="HEAD_OF_RESEARCH">Head of Research</option>
                            <option value="DATA_ANALYST">Data Analyst</option>
                            <option value="AZURE_INFRASTRUCTURE_AGENT">Azure Infrastructure Agent</option>
                            <option value="FULL_STACK_SOFTWARE_ENGINEER">Full Stack Software Engineer</option>
                            <option value="Research_Advanced_Analyst">Research Advanced Analyst</option>
                            <option value="Research_Intelligence_Orchestrator">Research Intelligence Orchestrator</option>
                            <option value="Research_Quantitative_Analyst">Research Quantitative Analyst</option>
                            <option value="Research_Strategy_Analyst">Research Strategy Analyst</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; font-weight: 500; color: var(--text-primary); margin-bottom: 0.5rem;">Paste Full Session Log:</label>
                        <textarea id="session-log-content" placeholder="Paste the complete Claude session log here..." style="width: 100%; height: 200px; padding: 0.75rem; background: var(--bg-dark); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 6px; font-family: SF Mono, Monaco, Consolas, monospace; font-size: 0.8rem; resize: vertical;"></textarea>
                        <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem;">Character count: <span id="char-count">0</span></div>
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; color: var(--text-secondary);">
                            <input type="checkbox" id="store-cosmos" checked style="accent-color: var(--accent-cyan);">
                            Store in Cosmos DB for Azure Analytics
                        </label>
                    </div>
                    
                    <div style="display: flex; gap: 1rem;">
                        <button id="save-log-btn" class="btn btn-primary" onclick="saveSessionLog()" style="flex: 1;">
                            <span>üíæ</span>Save Session Log
                        </button>
                        <button class="btn btn-secondary" onclick="clearLogForm()">
                            <span>üóëÔ∏è</span>Clear
                        </button>
                    </div>
                    
                    <div id="log-save-status" style="margin-top: 1rem; padding: 0.75rem; border-radius: 6px; background: var(--bg-dark); border: 1px solid var(--border-color); display: none;">
                        <div id="log-save-content"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Tab switching
        function switchTab(tabName) {
            // Update nav
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.closest('.nav-tab').classList.add('active');

            // Update content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}-tab`).classList.add('active');

            // Load tab-specific content
            if (tabName === 'memory') {
                loadMemoryLayers();
            } else if (tabName === 'agents') {
                loadDetailedAgents();
            } else if (tabName === 'cosmos') {
                loadCosmosTab();
            } else if (tabName === 'monitoring') {
                loadMonitoringTab();
            } else if (tabName === 'graph') {
                loadGraphTab();
            } else if (tabName === 'docs') {
                loadDocsTab();
            } else if (tabName === 'settings') {
                loadSettingsTab();
            }
        }

        // Toggle memory layer expansion
        function toggleLayer(layerId) {
            const content = document.getElementById(`${layerId}-content`);
            content.classList.toggle('expanded');
        }

        // Load memory layer content
        async function loadMemoryLayers() {
            try {
                const response = await fetch('/api/memory/layers');
                const data = await response.json();
                
                if (data.success && data.layers) {
                    // Load Layer 1 content
                    if (data.layers.layer1) {
                        const layer1Content = JSON.stringify(data.layers.layer1.content, null, 2);
                        document.getElementById('layer1-yaml').textContent = layer1Content;
                    }
                    
                    // Load Layer 2 content
                    if (data.layers.layer2) {
                        const layer2Content = JSON.stringify(data.layers.layer2.content, null, 2);
                        document.getElementById('layer2-yaml').textContent = layer2Content;
                    }
                    
                    // Load Layer 3 content
                    if (data.layers.layer3) {
                        const layer3Content = JSON.stringify(data.layers.layer3.content, null, 2);
                        document.getElementById('layer3-yaml').textContent = layer3Content;
                    }
                } else {
                    // Fallback to static content
                    loadStaticMemoryLayers();
                }
            } catch (error) {
                console.error('Error loading memory layers:', error);
                loadStaticMemoryLayers();
            }
        }

        function loadStaticMemoryLayers() {
            // Fallback static content
            const layer1Content = `# REPTILIAN_CORE.yaml
# ‚ö†Ô∏è DO NOT MODIFY - CONTACT HEAD_OF_ENGINEERING FOR ANY ISSUES

survival_rules:
  evidence_based_operation:
    rule: "Every claim requires evidence: filepath:line_number"
    violation_consequence: "Immediate correction required"
    
  no_hallucination:
    rule: "Never create fictional paths or claim non-existent files"
    violation_consequence: "Trust violation logged"
    
  security_reflexes:
    rule: "Never expose credentials, never hardcode secrets"
    violation_consequence: "Security breach protocol activated"

system_constraints:
  cosmos_db:
    connection: "ALWAYS use environment variables"
    naming: "lowercase_underscore only"
    containers: "system_inbox for all messaging"`;

            const layer2Content = `# IDENTITY_LAYER.yaml
# üîê RESTRICTED ACCESS - DUAL AUTHORIZATION REQUIRED

agent_identity:
  name: "HEAD_OF_ENGINEERING"
  role: "System Architecture & Database Management"
  clearance_level: "ADMIN"
  
capabilities:
  technical_domains: ["database", "infrastructure", "security"]
  tool_access: ["cosmos_admin", "system_config", "all_workspaces"]`;

            const layer3Content = `# WORKING_CONTEXT.yaml
# ‚úÖ AGENT CONTROLLED - Update freely within schema

current_session:
  timestamp: "${new Date().toISOString()}"
  active_task: "Dashboard implementation"
  priority_queue: ["Memory structure", "Professional styling", "Integration"]`;

            document.getElementById('layer1-yaml').textContent = layer1Content;
            document.getElementById('layer2-yaml').textContent = layer2Content;
            document.getElementById('layer3-yaml').textContent = layer3Content;
        }

        // Quick action functions
        function runHealthCheck() {
            console.log('Running health check...');
            // Implementation to call health check API
        }

        function checkMessages() {
            console.log('Checking system inbox...');
            // Implementation to check messages
        }

        function viewAgents() {
            switchTab('agents');
        }

        function optimizeDB() {
            console.log('Optimizing database...');
            // Implementation for DB optimization
        }

        function viewLogs() {
            console.log('Viewing logs...');
            // Implementation to view logs
        }

        function exportMetrics() {
            console.log('Exporting metrics...');
            // Implementation to export metrics
        }

        function validateMemoryStructure() {
            console.log('Validating memory structure...');
            // Implementation to validate the 3-layer structure
        }

        // Cost analysis function removed - not needed

        async function loadActiveAgents() {
            try {
                // Load agents with enhanced message status from our new API
                const response = await fetch('/api/live/agents');
                const data = await response.json();
                
                if (data.success) {
                    const content = document.getElementById('detailed-agents-content');
                    let html = '';
                    
                    data.agents.forEach(agent => {
                        const statusColor = {
                            'active': 'var(--success-green)',
                            'recent': 'var(--warning-amber)', 
                            'idle': 'var(--text-muted)',
                            'inactive': 'var(--danger-red)',
                            'unknown': 'var(--text-muted)'
                        }[agent.message_stats.status] || 'var(--text-muted)';
                        
                        // Enhanced message status breakdown
                        const messageStats = agent.message_stats;
                        const unreadCount = messageStats.unread_count || 0;
                        const pendingCount = messageStats.pending_count || 0;
                        const overdueCount = messageStats.overdue_count || 0;
                        
                        // Build status indicators with comprehensive message states
                        let statusIndicators = `<div style="font-size: 0.75rem; color: ${statusColor}; margin-bottom: 2px; font-weight: 500;">‚óè ${agent.message_stats.status}</div>`;
                        
                        if (unreadCount > 0) {
                            statusIndicators += `<div style="font-size: 0.7rem; color: var(--accent-cyan); margin: 1px 0;">üì¨ ${unreadCount} unread</div>`;
                        }
                        if (pendingCount > 0) {
                            statusIndicators += `<div style="font-size: 0.7rem; color: var(--warning-amber); margin: 1px 0;">‚è≥ ${pendingCount} pending</div>`;
                        }
                        if (overdueCount > 0) {
                            statusIndicators += `<div style="font-size: 0.7rem; color: var(--danger-red); margin: 1px 0;">‚ö†Ô∏è ${overdueCount} overdue</div>`;
                        }
                        
                        html += `
                            <div class="agent-item" style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 6px; margin: 0.5rem 0; cursor: pointer; background: var(--bg-card);" onclick="showAgentDetails('${agent.name}')">
                                <div>
                                    <div style="font-weight: 500; color: var(--text-primary);">${agent.name}</div>
                                    <div style="font-size: 0.75rem; color: var(--text-muted);">${agent.role}</div>
                                </div>
                                <div style="text-align: right;">
                                    ${statusIndicators}
                                </div>
                            </div>
                        `;
                    });
                    
                    content.innerHTML = html;
                } else {
                    document.getElementById('agents-list-content').innerHTML = '<div class="meta-item"><span class="meta-label">Error loading agents</span></div>';
                }
            } catch (error) {
                console.error('Agents loading error:', error);
                document.getElementById('agents-list-content').innerHTML = '<div class="meta-item"><span class="meta-label">Failed to load agents</span></div>';
            }
        }

        async function showAgentDetails(agentName) {
            try {
                // Load agent identity
                const identityResponse = await fetch(`/api/live/agent/${agentName}/identity`);
                const identityData = await identityResponse.json();
                
                // Load agent context
                const contextResponse = await fetch(`/api/live/agent/${agentName}/context`);
                const contextData = await contextResponse.json();
                
                // Create modal or detailed view
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
                    background: rgba(0,0,0,0.8); z-index: 1000; 
                    display: flex; align-items: center; justify-content: center;
                    padding: 2rem;
                `;
                
                modal.innerHTML = `
                    <div style="background: var(--bg-card); border-radius: 12px; padding: 0; max-width: 900px; max-height: 85vh; overflow: hidden; border: 1px solid var(--border-color);">
                        <!-- Modal Header -->
                        <div style="padding: 1.5rem 2rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                            <h2 style="color: var(--text-primary); margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                                <span>ü§ñ</span>${agentName}
                            </h2>
                            <button onclick="this.closest('.modal').remove()" style="background: var(--danger-red); color: white; border: none; border-radius: 6px; padding: 0.5rem 1rem; cursor: pointer;">‚úï Close</button>
                        </div>
                        
                        <!-- Agent Tabs Navigation -->
                        <div style="background: var(--bg-hover); border-bottom: 1px solid var(--border-color); padding: 0;">
                            <div style="display: flex; gap: 0;">
                                <button class="agent-tab active" onclick="switchAgentTab('identity', '${agentName}')" style="padding: 1rem 1.5rem; background: transparent; color: var(--text-primary); border: none; cursor: pointer; border-bottom: 2px solid var(--accent-cyan);">
                                    üìã Identity Card
                                </button>
                                <button class="agent-tab" onclick="switchAgentTab('context', '${agentName}')" style="padding: 1rem 1.5rem; background: transparent; color: var(--text-secondary); border: none; cursor: pointer; border-bottom: 2px solid transparent;">
                                    üß† Working Context
                                </button>
                                <button class="agent-tab" onclick="switchAgentTab('workspace', '${agentName}')" style="padding: 1rem 1.5rem; background: transparent; color: var(--text-secondary); border: none; cursor: pointer; border-bottom: 2px solid transparent;">
                                    üìÅ Workspace
                                </button>
                                <button class="agent-tab" onclick="switchAgentTab('journal', '${agentName}')" style="padding: 1rem 1.5rem; background: transparent; color: var(--text-secondary); border: none; cursor: pointer; border-bottom: 2px solid transparent;">
                                    üìñ Journal
                                </button>
                            </div>
                        </div>
                        
                        <!-- Tab Content -->
                        <div style="padding: 2rem; max-height: 60vh; overflow-y: auto;">
                            <!-- Identity Tab -->
                            <div id="agent-identity-tab" class="agent-tab-content active">
                                <div style="margin-bottom: 1rem;">
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                                        <div style="background: var(--bg-dark); padding: 1rem; border-radius: 6px;">
                                            <div style="color: var(--text-muted); font-size: 0.75rem; margin-bottom: 0.25rem;">ROLE</div>
                                            <div style="color: var(--text-primary); font-weight: 500;">${identityData.identity_card?.identity?.role || 'N/A'}</div>
                                        </div>
                                        <div style="background: var(--bg-dark); padding: 1rem; border-radius: 6px;">
                                            <div style="color: var(--text-muted); font-size: 0.75rem; margin-bottom: 0.25rem;">DEPARTMENT</div>
                                            <div style="color: var(--text-primary); font-weight: 500;">${identityData.identity_card?.identity?.department || 'N/A'}</div>
                                        </div>
                                        <div style="background: var(--bg-dark); padding: 1rem; border-radius: 6px;">
                                            <div style="color: var(--text-muted); font-size: 0.75rem; margin-bottom: 0.25rem;">CLEARANCE</div>
                                            <div style="color: var(--text-primary); font-weight: 500;">${identityData.identity_card?.identity?.clearance_level || 'N/A'}</div>
                                        </div>
                                    </div>
                                </div>
                                <h4 style="color: var(--accent-cyan); margin-bottom: 0.75rem;">Complete Identity Profile</h4>
                                <div style="background: var(--bg-dark); padding: 1rem; border-radius: 6px; font-family: monospace; font-size: 0.8rem; line-height: 1.4; overflow-x: auto;">
                                    <pre style="margin: 0; color: var(--text-secondary);">${JSON.stringify(identityData.identity_card || {}, null, 2)}</pre>
                                </div>
                            </div>
                            
                            <!-- Context Tab -->
                            <div id="agent-context-tab" class="agent-tab-content" style="display: none;">
                                <div style="margin-bottom: 1rem;">
                                    <div style="background: var(--bg-dark); padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
                                        <div style="color: var(--text-muted); font-size: 0.75rem; margin-bottom: 0.5rem;">CONTEXT STATUS</div>
                                        <div style="color: var(--text-primary);">${contextData.working_context ? 'Active working context found' : 'No active context'}</div>
                                        ${contextData.last_modified ? '<div style="color: var(--text-muted); font-size: 0.75rem; margin-top: 0.25rem;">Last Modified: ' + contextData.last_modified + '</div>' : ''}
                                    </div>
                                </div>
                                <h4 style="color: var(--accent-cyan); margin-bottom: 0.75rem;">Working Memory</h4>
                                <div style="background: var(--bg-dark); padding: 1rem; border-radius: 6px; font-family: monospace; font-size: 0.8rem; line-height: 1.4; overflow-x: auto;">
                                    <pre style="margin: 0; color: var(--text-secondary);">${JSON.stringify(contextData.working_context || {message: 'No working context data available'}, null, 2)}</pre>
                                </div>
                            </div>
                            
                            <!-- Workspace Tab -->
                            <div id="agent-workspace-tab" class="agent-tab-content" style="display: none;">
                                <div style="margin-bottom: 1rem;">
                                    <div style="background: var(--bg-dark); padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
                                        <div style="color: var(--text-muted); font-size: 0.75rem; margin-bottom: 0.5rem;">PRIMARY WORKSPACE</div>
                                        <div style="color: var(--text-primary); font-family: monospace; font-size: 0.875rem;">${identityData.identity_card?.workspace_assignment?.primary || 'No workspace assigned'}</div>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                                    <button onclick="openWorkspaceExplorer('${agentName}')" class="btn btn-primary">
                                        <span>üìÇ</span> Browse Files
                                    </button>
                                    <button onclick="window.open('${identityData.identity_card?.workspace_assignment?.primary || ''}', '_blank')" class="btn btn-secondary">
                                        <span>üîó</span> Open in Finder
                                    </button>
                                </div>
                                <div id="workspace-content-${agentName}" style="background: var(--bg-dark); padding: 1rem; border-radius: 6px; min-height: 200px;">
                                    <div style="color: var(--text-muted); text-align: center; padding: 2rem;">
                                        Click "Browse Files" to explore workspace contents
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Journal Tab -->
                            <div id="agent-journal-tab" class="agent-tab-content" style="display: none;">
                                <div style="margin-bottom: 1rem;">
                                    <div style="display: flex; gap: 1rem;">
                                        <button onclick="loadAgentJournalContent('${agentName}')" class="btn btn-primary">
                                            <span>üìñ</span> Load Journal
                                        </button>
                                        <button onclick="searchAgentDocs('${agentName}')" class="btn btn-secondary">
                                            <span>üîç</span> Search Documents
                                        </button>
                                    </div>
                                </div>
                                <div id="journal-content-${agentName}" style="background: var(--bg-dark); padding: 1rem; border-radius: 6px; min-height: 200px;">
                                    <div style="color: var(--text-muted); text-align: center; padding: 2rem;">
                                        Click "Load Journal" to view agent's documentation and notes
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                modal.className = 'modal';
                document.body.appendChild(modal);
                
            } catch (error) {
                console.error('Error loading agent details:', error);
                alert('Failed to load agent details');
            }
        }

        // Agent Modal Tab Functions
        function switchAgentTab(tabName, agentName) {
            // Update tab buttons
            document.querySelectorAll('.agent-tab').forEach(tab => {
                tab.style.color = 'var(--text-secondary)';
                tab.style.borderBottomColor = 'transparent';
            });
            
            // Update content
            document.querySelectorAll('.agent-tab-content').forEach(content => {
                content.style.display = 'none';
            });
            
            // Activate selected tab
            event.target.style.color = 'var(--text-primary)';
            event.target.style.borderBottomColor = 'var(--accent-cyan)';
            document.getElementById(`agent-${tabName}-tab`).style.display = 'block';
        }

        async function openWorkspaceExplorer(agentName) {
            try {
                // Get workspace path from agent identity
                const identityResponse = await fetch(`/api/live/agent/${agentName}/identity`);
                const identityData = await identityResponse.json();
                
                if (identityData.success) {
                    const workspacePath = identityData.identity_card?.workspace_assignment?.primary;
                    
                    if (workspacePath) {
                        // Use docs search to find files in the workspace
                        const searchResponse = await fetch(`/api/docs/search?q=${agentName}`);
                        const searchData = await searchResponse.json();
                        
                        const workspaceContent = document.getElementById(`workspace-content-${agentName}`);
                        
                        if (searchData.success && searchData.results.length > 0) {
                            let html = `
                                <h4 style="color: var(--accent-cyan); margin-bottom: 1rem;">Files found in ${agentName}'s workspace:</h4>
                            `;
                            
                            searchData.results.slice(0, 10).forEach(file => {
                                html += `
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 6px; margin: 0.5rem 0;">
                                        <div>
                                            <div style="font-weight: 500; color: var(--text-primary); font-size: 0.875rem;">${file.name}</div>
                                            <div style="font-size: 0.75rem; color: var(--text-muted);">${file.path}</div>
                                            <div style="font-size: 0.7rem; color: var(--text-muted);">${file.match_count} matches</div>
                                        </div>
                                        <button onclick="openDocFile('${file.path}')" class="btn btn-secondary" style="font-size: 0.75rem; padding: 0.375rem 0.75rem;">
                                            Open
                                        </button>
                                    </div>
                                `;
                            });
                            
                            workspaceContent.innerHTML = html;
                        } else {
                            workspaceContent.innerHTML = `
                                <div style="text-align: center; padding: 2rem; color: var(--text-muted);">
                                    <div style="font-size: 2rem; margin-bottom: 1rem;">üìÅ</div>
                                    <div>No files found for this agent</div>
                                    <div style="font-size: 0.875rem; margin-top: 0.5rem;">Try browsing the workspace directly</div>
                                </div>
                            `;
                        }
                    } else {
                        workspaceContent.innerHTML = `
                            <div style="text-align: center; padding: 2rem; color: var(--warning-amber);">
                                <div style="font-size: 2rem; margin-bottom: 1rem;">‚ö†Ô∏è</div>
                                <div>No workspace assigned to this agent</div>
                            </div>
                        `;
                    }
                }
            } catch (error) {
                console.error('Error loading workspace:', error);
                document.getElementById(`workspace-content-${agentName}`).innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: var(--danger-red);">
                        <div>Error loading workspace files</div>
                    </div>
                `;
            }
        }

        async function loadAgentJournalContent(agentName) {
            try {
                const journalContent = document.getElementById(`journal-content-${agentName}`);
                journalContent.innerHTML = '<div style="text-align: center; padding: 2rem;"><div class="spinner"></div><span style="margin-left: 1rem;">Loading journal...</span></div>';
                
                // Search for agent-specific documentation
                const response = await fetch(`/api/docs/search?q=${agentName}`);
                const data = await response.json();
                
                if (data.success && data.results.length > 0) {
                    let html = `
                        <h4 style="color: var(--accent-cyan); margin-bottom: 1rem;">üìñ ${agentName}'s Documentation & Notes</h4>
                        <div style="margin-bottom: 1rem; font-size: 0.875rem; color: var(--text-muted);">
                            Found ${data.results.length} documents with relevant content
                        </div>
                    `;
                    
                    // Look for journal-like files first
                    const journalFiles = data.results.filter(file => 
                        file.name.toLowerCase().includes('journal') || 
                        file.name.toLowerCase().includes('memory') ||
                        file.name.toLowerCase().includes('context') ||
                        file.name.toLowerCase().includes('notes')
                    );
                    
                    if (journalFiles.length > 0) {
                        html += '<div style="margin-bottom: 1.5rem;"><h5 style="color: var(--success-green); margin-bottom: 0.5rem;">üìù Journal & Memory Files</h5>';
                        journalFiles.forEach(file => {
                            html += `
                                <div style="background: var(--bg-card); border: 1px solid var(--success-green); border-radius: 6px; padding: 1rem; margin: 0.5rem 0;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                        <div style="font-weight: 500; color: var(--text-primary);">${file.name}</div>
                                        <button onclick="openDocFile('${file.path}')" class="btn btn-primary" style="font-size: 0.75rem; padding: 0.375rem 0.75rem;">View</button>
                                    </div>
                                    <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.5rem;">${file.path}</div>
                                    ${file.matches.slice(0, 3).map(match => `
                                        <div style="font-size: 0.7rem; color: var(--text-secondary); margin: 0.25rem 0; padding: 0.5rem; background: var(--bg-dark); border-radius: 4px; border-left: 3px solid var(--success-green);">
                                            Line ${match.line}: ${match.text}
                                        </div>
                                    `).join('')}
                                </div>
                            `;
                        });
                        html += '</div>';
                    }
                    
                    // Show other relevant files
                    const otherFiles = data.results.filter(file => !journalFiles.includes(file));
                    if (otherFiles.length > 0) {
                        html += '<div><h5 style="color: var(--accent-cyan); margin-bottom: 0.5rem;">üìÑ Related Documentation</h5>';
                        otherFiles.slice(0, 5).forEach(file => {
                            html += `
                                <div style="background: var(--bg-dark); border: 1px solid var(--border-color); border-radius: 6px; padding: 1rem; margin: 0.5rem 0;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                        <div style="font-weight: 500; color: var(--text-primary);">${file.name}</div>
                                        <button onclick="openDocFile('${file.path}')" class="btn btn-secondary" style="font-size: 0.75rem; padding: 0.375rem 0.75rem;">View</button>
                                    </div>
                                    <div style="font-size: 0.75rem; color: var(--text-muted);">${file.match_count} matches in ${file.path}</div>
                                </div>
                            `;
                        });
                        html += '</div>';
                    }
                    
                    journalContent.innerHTML = html;
                } else {
                    journalContent.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: var(--text-muted);">
                            <div style="font-size: 2rem; margin-bottom: 1rem;">üìñ</div>
                            <div>No journal or documentation found for ${agentName}</div>
                            <div style="font-size: 0.875rem; margin-top: 0.5rem;">Try creating documentation files in the agent's workspace</div>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Error loading journal:', error);
                document.getElementById(`journal-content-${agentName}`).innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: var(--danger-red);">
                        <div>Error loading journal content</div>
                    </div>
                `;
            }
        }

        async function searchAgentDocs(agentName) {
            const searchTerm = prompt(`Search ${agentName}'s documentation:`, agentName);
            if (searchTerm) {
                loadAgentJournalContent(agentName); // Reload with current search
            }
        }

        function loadAgentJournal(agentName) {
            // Legacy function - now handled by the tabbed interface
            loadAgentJournalContent(agentName);
        }

        async function loadCoreDocuments() {
            try {
                console.log('üìÑ Loading core documents...');
                const response = await fetch('/api/live/core-documents');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('üìÑ Core documents response:', data);
                
                if (data.success && data.core_documents) {
                    const content = document.getElementById('core-documents-content');
                    let html = '';
                    
                    Object.entries(data.core_documents).forEach(([id, doc]) => {
                        const categoryColors = {
                            'Architecture': 'var(--accent-blue)',
                            'Operations': 'var(--success-green)',
                            'Management': 'var(--warning-amber)',
                            'Governance': 'var(--danger-red)',
                            'Status': 'var(--accent-cyan)'
                        };
                        
                        const categoryColor = categoryColors[doc.category] || 'var(--text-muted)';
                        const existsIcon = doc.exists ? '‚úÖ' : '‚ùå';
                        
                        html += `
                            <div class="document-item" style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 6px; margin: 0.5rem 0; cursor: pointer;" onclick="openDocument('${id}')">
                                <div>
                                    <div style="font-weight: 500; color: var(--text-primary);">${existsIcon} ${doc.title}</div>
                                    <div style="font-size: 0.75rem; color: var(--text-muted);">${doc.description}</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 0.75rem; color: ${categoryColor}; font-weight: 500;">${doc.category}</div>
                                    ${doc.exists ? `<div style="font-size: 0.7rem; color: var(--text-muted);">${(doc.size / 1024).toFixed(1)}KB</div>` : ''}
                                </div>
                            </div>
                        `;
                    });
                    
                    content.innerHTML = html;
                } else {
                    document.getElementById('core-documents-content').innerHTML = '<div class="meta-item"><span class="meta-label">Error loading documents</span></div>';
                }
            } catch (error) {
                console.error('Core documents loading error:', error);
                document.getElementById('core-documents-content').innerHTML = '<div class="meta-item"><span class="meta-label">Failed to load documents</span></div>';
            }
        }

        async function openDocument(docId) {
            try {
                const response = await fetch('/api/live/core-documents');
                const data = await response.json();
                
                if (data.success && data.core_documents && data.core_documents[docId]) {
                    const doc = data.core_documents[docId];
                    if (doc.exists) {
                        // Open document in modal instead of new window
                        openDocumentModal(doc.path);
                    } else {
                        alert(`Document "${doc.title}" not found at ${doc.path}`);
                    }
                }
            } catch (error) {
                console.error('Error opening document:', error);
                alert('Failed to open document');
            }
        }

        // Detailed Agents Tab Functions
        async function loadDetailedAgents() {
            try {
                const response = await fetch('/api/live/agents');
                const data = await response.json();
                
                if (data.success) {
                    const content = document.getElementById('detailed-agents-content');
                    let html = '';
                    
                    data.agents.forEach(agent => {
                        const statusColor = {
                            'active': 'var(--success-green)',
                            'recent': 'var(--warning-amber)', 
                            'idle': 'var(--text-muted)',
                            'inactive': 'var(--danger-red)',
                            'unknown': 'var(--text-muted)'
                        }[agent.message_stats.status] || 'var(--text-muted)';
                        
                        html += `
                            <div class="card">
                                <div class="card-header">
                                    <h4 style="color: var(--text-primary); margin: 0; font-size: 1rem;">${agent.name}</h4>
                                    <div style="font-size: 0.75rem; color: ${statusColor};">‚óè ${agent.message_stats.status}</div>
                                </div>
                                <div class="grid" style="gap: 0.75rem;">
                                    <div class="meta-item">
                                        <span class="meta-label">Role</span>
                                        <span class="meta-value">${agent.role}</span>
                                    </div>
                                    <div class="meta-item">
                                        <span class="meta-label">Department</span>
                                        <span class="meta-value">${agent.department}</span>
                                    </div>
                                    <div class="meta-item">
                                        <span class="meta-label">Clearance</span>
                                        <span class="meta-value">${agent.clearance}</span>
                                    </div>
                                    <div class="meta-item">
                                        <span class="meta-label">Unread Messages</span>
                                        <span class="meta-value">${agent.message_stats.unread_count}</span>
                                    </div>
                                </div>
                                <div style="margin-top: 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                    <button class="btn btn-secondary" onclick="showAgentDetails('${agent.name}')" style="font-size: 0.75rem; padding: 0.375rem 0.75rem;">View Details</button>
                                    <button class="btn btn-secondary" onclick="window.open('${agent.links.workspace}', '_blank')" style="font-size: 0.75rem; padding: 0.375rem 0.75rem;">Open Workspace</button>
                                </div>
                            </div>
                        `;
                    });
                    
                    content.innerHTML = html;
                } else {
                    document.getElementById('detailed-agents-content').innerHTML = '<div class="meta-item"><span class="meta-label">Error loading agents</span></div>';
                }
            } catch (error) {
                console.error('Detailed agents loading error:', error);
                document.getElementById('detailed-agents-content').innerHTML = '<div class="meta-item"><span class="meta-label">Failed to load agents</span></div>';
            }
        }

        function refreshAgents() {
            loadDetailedAgents();
            loadActiveAgents();
        }

        // Cosmos DB Tab Functions
        async function loadCosmosTab() {
            loadCosmosOverview();
            loadCosmosContainers();
            loadContainerSelect();
        }

        async function loadCosmosOverview() {
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();
                
                if (data.success) {
                    const stats = data.stats;
                    const content = document.getElementById('cosmos-overview-content');
                    
                    // Calculate values from actual API response
                    const totalContainers = Object.keys(stats.containers).length;
                    const totalItems = stats.totalDocuments;
                    const database = stats.database;
                    const endpoint = stats.endpoint;
                    
                    content.innerHTML = `
                        <div class="grid" style="gap: 0.75rem;">
                            <div class="meta-item">
                                <span class="meta-label">Database</span>
                                <span class="meta-value">${database}</span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-label">Total Containers</span>
                                <span class="meta-value">${totalContainers}</span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-label">Total Documents</span>
                                <span class="meta-value">${totalItems.toLocaleString()}</span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-label">Status</span>
                                <span class="meta-value" style="color: var(--success-green);">Connected</span>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Cosmos overview error:', error);
            }
        }

        async function loadCosmosContainers() {
            try {
                const response = await fetch('/api/containers');
                const data = await response.json();
                
                if (data.success) {
                    const content = document.getElementById('cosmos-containers-content');
                    let html = '';
                    
                    data.containers.slice(0, 8).forEach(container => {
                        html += `
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 4px; margin: 0.25rem 0;">
                                <span style="font-size: 0.75rem; color: var(--text-primary);">${container.id}</span>
                                <span style="font-size: 0.7rem; color: var(--text-muted);">${container.count} items</span>
                            </div>
                        `;
                    });
                    
                    content.innerHTML = html;
                }
            } catch (error) {
                console.error('Cosmos containers error:', error);
            }
        }

        async function loadContainerSelect() {
            try {
                const response = await fetch('/api/containers');
                const data = await response.json();
                
                if (data.success) {
                    const select = document.getElementById('container-select');
                    let html = '<option>Select Container...</option>';
                    
                    data.containers.forEach(container => {
                        html += `<option value="${container.id}">${container.id} (${container.count} items)</option>`;
                    });
                    
                    select.innerHTML = html;
                }
            } catch (error) {
                console.error('Container select error:', error);
            }
        }

        async function loadContainerData() {
            const select = document.getElementById('container-select');
            const containerId = select.value;
            
            if (!containerId || containerId === 'Select Container...') {
                alert('Please select a container first');
                return;
            }
            
            try {
                const response = await fetch(`/api/containers/${containerId}/documents?limit=5`);
                const data = await response.json();
                
                if (data.success) {
                    const content = document.getElementById('container-data-content');
                    let html = `<h4 style="color: var(--text-primary); margin-bottom: 1rem;">Recent documents from ${containerId}:</h4>`;
                    
                    data.documents.forEach((doc, index) => {
                        html += `
                            <div style="background: var(--bg-card); padding: 1rem; border-radius: 4px; margin: 0.5rem 0; border: 1px solid var(--border-color);">
                                <div style="font-weight: 500; color: var(--text-primary); margin-bottom: 0.5rem;">Document ${index + 1}: ${doc.id}</div>
                                <pre style="font-size: 0.7rem; color: var(--text-secondary); max-height: 100px; overflow-y: auto; background: var(--bg-dark); padding: 0.5rem; border-radius: 4px;">${JSON.stringify(doc, null, 2)}</pre>
                                <button class="view-document-btn" onclick='viewDocument(${JSON.stringify(doc).replace(/'/g, "&apos;")}, "${containerId}")'>View Full Document</button>
                            </div>
                        `;
                    });
                    
                    content.innerHTML = html;
                } else {
                    document.getElementById('container-data-content').innerHTML = `<div style="color: var(--danger-red);">Error: ${data.error}</div>`;
                }
            } catch (error) {
                console.error('Container data error:', error);
                document.getElementById('container-data-content').innerHTML = `<div style="color: var(--danger-red);">Failed to load container data</div>`;
            }
        }
        
        // Enhanced Document Modal Functions
        function viewDocument(doc, containerId) {
            const modal = document.getElementById('documentModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalContent = document.getElementById('modalContent');
            
            // Set title with more context
            modalTitle.textContent = `üìÑ ${doc.subject || doc.filename || doc.id} (${containerId})`;
            
            // Create tabbed interface for better content organization
            let html = `
                <div class="document-viewer-container">
                    <!-- Enhanced Metadata Section -->
                    <div class="document-meta-enhanced">
                        <div class="meta-section">
                            <h4>üìã Document Information</h4>
                            <div class="meta-grid">
                                <div class="meta-item">
                                    <span class="meta-label">ID</span>
                                    <span class="meta-value">${doc.id || 'N/A'}</span>
                                </div>
                                <div class="meta-item">
                                    <span class="meta-label">Container</span>
                                    <span class="meta-value">${containerId}</span>
                                </div>
                                <div class="meta-item">
                                    <span class="meta-label">Size</span>
                                    <span class="meta-value">${formatBytes(JSON.stringify(doc).length)}</span>
                                </div>
                                <div class="meta-item">
                                    <span class="meta-label">Timestamp</span>
                                    <span class="meta-value">${formatTimestamp(doc.timestamp || doc._ts)}</span>
                                </div>
            `;
            
            // Add context-specific metadata
            if (doc.agent_name) {
                html += `
                    <div class="meta-item">
                        <span class="meta-label">Agent</span>
                        <span class="meta-value">${doc.agent_name}</span>
                    </div>
                `;
            }
            
            if (doc.from && doc.to) {
                html += `
                    <div class="meta-item">
                        <span class="meta-label">From ‚Üí To</span>
                        <span class="meta-value">${doc.from} ‚Üí ${doc.to}</span>
                    </div>
                `;
            }
            
            if (doc.subject) {
                html += `
                    <div class="meta-item">
                        <span class="meta-label">Subject</span>
                        <span class="meta-value">${doc.subject}</span>
                    </div>
                `;
            }
            
            if (doc.storage_type) {
                html += `
                    <div class="meta-item">
                        <span class="meta-label">Storage Type</span>
                        <span class="meta-value">${doc.storage_type === 'blob' ? '‚òÅÔ∏è Azure Blob' : 'üí´ Cosmos DB'}</span>
                    </div>
                `;
            }
            
            if (doc.blob_url) {
                html += `
                    <div class="meta-item">
                        <span class="meta-label">Blob URL</span>
                        <span class="meta-value"><a href="${doc.blob_url}" target="_blank" style="color: var(--accent-cyan);">View in Azure</a></span>
                    </div>
                `;
            }
            
            html += `
                            </div>
                        </div>
                    </div>
                    
                    <!-- Content Navigation Tabs -->
                    <div class="content-tabs">
                        <button class="content-tab active" onclick="showContentTab('readable')">üìñ Readable View</button>
                        <button class="content-tab" onclick="showContentTab('json')">üîß Raw JSON</button>
                    </div>
                    
                    <!-- Content Panels -->
                    <div class="content-panels">
                        <!-- Readable Content Panel -->
                        <div id="readable-panel" class="content-panel active">
            `;
            
            // Enhanced content display
            let hasMainContent = false;
            
            // Message content
            if (doc.content && typeof doc.content === 'string') {
                hasMainContent = true;
                html += `
                    <div class="content-section">
                        <h4 class="content-header">üí¨ Message Content</h4>
                        <div class="content-text">${formatContent(doc.content)}</div>
                    </div>
                `;
            }
            
            // Log content
            if (doc.log_content && typeof doc.log_content === 'string') {
                hasMainContent = true;
                html += `
                    <div class="content-section">
                        <h4 class="content-header">üìù Log Content</h4>
                        <div class="content-text">${formatContent(doc.log_content)}</div>
                    </div>
                `;
            }
            
            // Preview content
            if (doc.content_preview && typeof doc.content_preview === 'string') {
                hasMainContent = true;
                html += `
                    <div class="content-section">
                        <h4 class="content-header">üëÅÔ∏è Content Preview</h4>
                        <div class="content-text">${formatContent(doc.content_preview)}</div>
                        ${doc.blob_url ? '<p style="color: var(--warning-amber); margin-top: 1rem;"><em>üìé Full content available in Azure Blob Storage</em></p>' : ''}
                    </div>
                `;
            }
            
            // If no main content found, show helpful message
            if (!hasMainContent) {
                html += `
                    <div class="content-section">
                        <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                            <h4>üìÑ Document Structure</h4>
                            <p>This document contains structured data. Switch to the "Raw JSON" tab to view all fields.</p>
                        </div>
                    </div>
                `;
            }
            
            html += `
                        </div>
                        
                        <!-- JSON Panel -->
                        <div id="json-panel" class="content-panel">
                            <div class="json-viewer">
                                <pre>${JSON.stringify(doc, null, 2)}</pre>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            modalContent.innerHTML = html;
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
        }
        
        // Helper functions for enhanced viewer
        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        function formatTimestamp(timestamp) {
            if (!timestamp) return 'N/A';
            
            // Handle Unix timestamp
            if (typeof timestamp === 'number') {
                return new Date(timestamp * 1000).toLocaleString();
            }
            
            // Handle ISO string
            if (typeof timestamp === 'string') {
                return new Date(timestamp).toLocaleString();
            }
            
            return timestamp;
        }
        
        function formatContent(content) {
            if (!content) return '';
            
            // Convert markdown-style formatting
            let formatted = escapeHtml(content);
            
            // Headers
            formatted = formatted.replace(/^## (.*$)/gm, '<h3 style="color: var(--accent-cyan); margin: 1.5rem 0 0.5rem 0;">$1</h3>');
            formatted = formatted.replace(/^### (.*$)/gm, '<h4 style="color: var(--text-primary); margin: 1rem 0 0.5rem 0;">$1</h4>');
            
            // Code blocks
            formatted = formatted.replace(/```(\w+)?\n([\s\S]*?)\n```/g, '<pre style="background: var(--bg-dark); padding: 1rem; border-radius: 6px; overflow-x: auto; margin: 1rem 0;"><code>$2</code></pre>');
            
            // Inline code
            formatted = formatted.replace(/`([^`]+)`/g, '<code style="background: var(--bg-hover); padding: 0.2rem 0.4rem; border-radius: 3px; font-family: monospace;">$1</code>');
            
            // Links
            formatted = formatted.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" style="color: var(--accent-cyan);">$1</a>');
            
            // Preserve line breaks
            formatted = formatted.replace(/\n/g, '<br>');
            
            return formatted;
        }
        
        function showContentTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.content-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[onclick="showContentTab('${tabName}')"]`).classList.add('active');
            
            // Update panels
            document.querySelectorAll('.content-panel').forEach(panel => {
                panel.classList.remove('active');
            });
            document.getElementById(`${tabName}-panel`).classList.add('active');
        }
        
        function closeDocumentModal(event) {
            if (!event || event.target.id === 'documentModal') {
                const modal = document.getElementById('documentModal');
                modal.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Add keyboard shortcut to close modal
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeDocumentModal();
            }
        });

        // Monitoring Tab Functions
        async function loadMonitoringTab() {
            loadSystemHealth();
        }

        async function loadSystemHealth() {
            try {
                const response = await fetch('/api/live/system-health');
                const data = await response.json();
                
                if (data.success) {
                    const health = data.health;
                    const content = document.getElementById('system-health-content');
                    
                    const statusColor = health.overall_status === 'healthy' ? 'var(--success-green)' : 'var(--warning-amber)';
                    
                    let html = `
                        <div class="meta-item" style="margin-bottom: 1rem;">
                            <span class="meta-label">Overall Status</span>
                            <span class="meta-value" style="color: ${statusColor};">${health.overall_status.toUpperCase()}</span>
                        </div>
                        <div class="grid" style="gap: 0.75rem;">
                            <div class="meta-item">
                                <span class="meta-label">Cosmos DB</span>
                                <span class="meta-value">${health.cosmos_db.connected ? '‚úÖ Connected' : '‚ùå Disconnected'}</span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-label">Containers</span>
                                <span class="meta-value">${health.cosmos_db.containers} active</span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-label">Workspaces</span>
                                <span class="meta-value">${health.file_system.workspaces_accessible}/5 accessible</span>
                            </div>
                        </div>
                    `;
                    
                    if (health.issues && health.issues.length > 0) {
                        html += `
                            <div style="margin-top: 1rem; padding: 0.75rem; background: rgba(245, 158, 11, 0.1); border-radius: 6px;">
                                <strong style="color: var(--warning-amber);">Issues:</strong>
                                <ul style="margin: 0.5rem 0; padding-left: 1rem;">
                                    ${health.issues.map(issue => `<li style="color: var(--text-secondary); font-size: 0.875rem;">${issue}</li>`).join('')}
                                </ul>
                            </div>
                        `;
                    }
                    
                    content.innerHTML = html;
                } else {
                    document.getElementById('system-health-content').innerHTML = '<div class="meta-item"><span class="meta-label">Health check failed</span></div>';
                }
            } catch (error) {
                console.error('System health error:', error);
                document.getElementById('system-health-content').innerHTML = '<div class="meta-item"><span class="meta-label">Health check error</span></div>';
            }
        }

        function runSystemCheck() {
            loadSystemHealth();
            alert('System check completed - results updated');
        }

        function exportLogs() {
            window.open('/api/containers/logs/documents', '_blank');
        }

        function clearCache() {
            if (confirm('Clear browser cache? This will refresh the page.')) {
                localStorage.clear();
                sessionStorage.clear();
                location.reload();
            }
        }

        // Documentation Tab Functions
        async function loadDocsTab() {
            try {
                const response = await fetch('/api/docs/structure');
                const data = await response.json();
                
                if (data.success) {
                    const content = document.getElementById('docs-browser-content');
                    let html = `
                        <div style="margin-bottom: 1rem; padding: 1rem; background: var(--bg-dark); border-radius: 6px;">
                            <div class="grid grid-3" style="gap: 1rem;">
                                <div class="meta-item">
                                    <span class="meta-label">Total Files</span>
                                    <span class="meta-value">${data.stats.total_files}</span>
                                </div>
                                <div class="meta-item">
                                    <span class="meta-label">Categories</span>
                                    <span class="meta-value">${data.stats.categories}</span>
                                </div>
                                <div class="meta-item">
                                    <span class="meta-label">Total Size</span>
                                    <span class="meta-value">${(data.stats.total_size / 1024).toFixed(1)} KB</span>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    Object.entries(data.structure).forEach(([category, files]) => {
                        html += `
                            <div style="margin-bottom: 1.5rem;">
                                <h4 style="color: var(--accent-cyan); margin-bottom: 0.5rem; font-size: 1rem;">${category}</h4>
                                <div style="background: var(--bg-dark); border-radius: 6px; padding: 0.5rem;">
                        `;
                        
                        files.slice(0, 10).forEach(file => {
                            html += `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; border-bottom: 1px solid var(--border-color); cursor: pointer;" onclick="openDocFile('${file.path}')">
                                    <div>
                                        <div style="font-size: 0.875rem; color: var(--text-primary);">${file.name}</div>
                                        <div style="font-size: 0.7rem; color: var(--text-muted);">${(file.size / 1024).toFixed(1)} KB</div>
                                    </div>
                                    <span style="font-size: 0.7rem; color: var(--text-muted);">‚Üí</span>
                                </div>
                            `;
                        });
                        
                        html += `</div></div>`;
                    });
                    
                    content.innerHTML = html;
                } else {
                    document.getElementById('docs-browser-content').innerHTML = '<div class="meta-item"><span class="meta-label">Error loading documentation</span></div>';
                }
            } catch (error) {
                console.error('Docs loading error:', error);
                document.getElementById('docs-browser-content').innerHTML = '<div class="meta-item"><span class="meta-label">Failed to load documentation</span></div>';
            }
        }

        function openDocFile(path) {
            // Open document in a modal instead of new window
            openDocumentModal(path);
        }

        async function openDocumentModal(path) {
            try {
                const response = await fetch(`/api/docs/content?path=${encodeURIComponent(path)}`);
                const data = await response.json();
                
                if (data.success) {
                    // Create document modal
                    const modal = document.createElement('div');
                    modal.style.cssText = `
                        position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
                        background: rgba(0,0,0,0.8); z-index: 1000; 
                        display: flex; align-items: center; justify-content: center;
                        padding: 2rem;
                    `;
                    
                    const fileExtension = path.split('.').pop().toLowerCase();
                    const isMarkdown = fileExtension === 'md';
                    const isPython = fileExtension === 'py';
                    
                    let contentHtml = '';
                    if (isMarkdown) {
                        // Simple markdown rendering
                        contentHtml = data.content
                            .replace(/^# (.*$)/gm, '<h1 style="color: var(--accent-cyan); margin: 1.5rem 0 1rem 0; font-size: 1.5rem;">$1</h1>')
                            .replace(/^## (.*$)/gm, '<h2 style="color: var(--accent-blue); margin: 1.25rem 0 0.75rem 0; font-size: 1.25rem;">$1</h2>')
                            .replace(/^### (.*$)/gm, '<h3 style="color: var(--text-primary); margin: 1rem 0 0.5rem 0; font-size: 1.1rem;">$1</h3>')
                            .replace(/\*\*(.*?)\*\*/g, '<strong style="color: var(--text-primary);">$1</strong>')
                            .replace(/\*(.*?)\*/g, '<em style="color: var(--text-secondary);">$1</em>')
                            .replace(/\`(.*?)\`/g, '<code style="background: var(--bg-dark); padding: 0.125rem 0.375rem; border-radius: 3px; font-family: monospace; color: var(--accent-cyan);">$1</code>')
                            .replace(/^- (.*$)/gm, '<li style="margin: 0.25rem 0; color: var(--text-secondary);">$1</li>')
                            .replace(/\n\n/g, '</p><p style="margin: 1rem 0; line-height: 1.6; color: var(--text-secondary);">')
                            .replace(/^(?!<[h|l|p])/gm, '<p style="margin: 1rem 0; line-height: 1.6; color: var(--text-secondary);">') + '</p>';
                    } else {
                        contentHtml = `<pre style="margin: 0; color: var(--text-secondary); line-height: 1.4; white-space: pre-wrap;">${data.content}</pre>`;
                    }
                    
                    modal.innerHTML = `
                        <div style="background: var(--bg-card); border-radius: 12px; padding: 0; max-width: 1000px; max-height: 90vh; overflow: hidden; border: 1px solid var(--border-color); width: 100%;">
                            <!-- Document Header -->
                            <div style="padding: 1.5rem 2rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; background: var(--bg-hover);">
                                <div>
                                    <h2 style="color: var(--text-primary); margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                                        <span>${isMarkdown ? 'üìÑ' : isPython ? 'üêç' : 'üìù'}</span>${path.split('/').pop()}
                                    </h2>
                                    <div style="font-size: 0.875rem; color: var(--text-muted); margin-top: 0.25rem;">${path}</div>
                                    <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem;">
                                        ${(data.size / 1024).toFixed(1)} KB ‚Ä¢ Modified: ${new Date(data.modified).toLocaleString()}
                                    </div>
                                </div>
                                <div style="display: flex; gap: 1rem; align-items: center;">
                                    <button onclick="copyDocContent('${path.replace(/'/g, "\\'")}')" class="btn btn-secondary" style="font-size: 0.875rem; padding: 0.5rem 1rem;">
                                        üìã Copy
                                    </button>
                                    <button onclick="window.open('/api/docs/content?path=${encodeURIComponent(path)}', '_blank')" class="btn btn-secondary" style="font-size: 0.875rem; padding: 0.5rem 1rem;">
                                        üîó Open Raw
                                    </button>
                                    <button onclick="this.closest('.document-modal').remove()" class="btn btn-danger" style="font-size: 0.875rem; padding: 0.5rem 1rem;">
                                        ‚úï Close
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Document Content -->
                            <div style="padding: 2rem; max-height: 70vh; overflow-y: auto; background: var(--bg-card);">
                                <div style="font-family: ${isMarkdown ? 'Inter, sans-serif' : 'SF Mono, Monaco, Consolas, monospace'}; font-size: ${isMarkdown ? '0.9rem' : '0.8rem'};">
                                    ${contentHtml}
                                </div>
                            </div>
                        </div>
                    `;
                    
                    modal.className = 'document-modal';
                    document.body.appendChild(modal);
                    
                    // Close on background click
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            modal.remove();
                        }
                    });
                    
                } else {
                    alert(`Failed to load document: ${data.error}`);
                }
            } catch (error) {
                console.error('Error loading document:', error);
                alert('Failed to load document');
            }
        }

        async function copyDocContent(path) {
            try {
                const response = await fetch(`/api/docs/content?path=${encodeURIComponent(path)}`);
                const data = await response.json();
                
                if (data.success) {
                    await navigator.clipboard.writeText(data.content);
                    // Show temporary success message
                    const button = event.target;
                    const originalText = button.innerHTML;
                    button.innerHTML = '‚úÖ Copied!';
                    button.style.background = 'var(--success-green)';
                    setTimeout(() => {
                        button.innerHTML = originalText;
                        button.style.background = '';
                    }, 2000);
                } else {
                    alert('Failed to copy content');
                }
            } catch (error) {
                console.error('Error copying content:', error);
                alert('Failed to copy content');
            }
        }

        async function searchDocs() {
            const searchTerm = document.getElementById('docs-search').value;
            if (!searchTerm) {
                alert('Please enter a search term');
                return;
            }
            
            try {
                const response = await fetch(`/api/docs/search?q=${encodeURIComponent(searchTerm)}`);
                const data = await response.json();
                
                if (data.success) {
                    const content = document.getElementById('docs-browser-content');
                    let html = `<h4 style="color: var(--accent-cyan); margin-bottom: 1rem;">Search results for "${searchTerm}" (${data.total} found):</h4>`;
                    
                    data.results.forEach(result => {
                        html += `
                            <div style="background: var(--bg-dark); padding: 1rem; border-radius: 6px; margin: 0.5rem 0; border: 1px solid var(--border-color);">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                    <div style="font-weight: 500; color: var(--text-primary);">${result.name}</div>
                                    <button class="btn btn-secondary" onclick="openDocFile('${result.path}')" style="font-size: 0.75rem; padding: 0.25rem 0.5rem;">Open</button>
                                </div>
                                <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.5rem;">${result.path} (${result.match_count} matches)</div>
                                ${result.matches.map(match => `
                                    <div style="font-size: 0.7rem; color: var(--text-secondary); margin: 0.25rem 0; padding: 0.25rem; background: var(--bg-card); border-radius: 4px;">
                                        Line ${match.line}: ${match.text}
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    });
                    
                    content.innerHTML = html;
                }
            } catch (error) {
                console.error('Search error:', error);
                alert('Search failed');
            }
        }

        // Settings Tab Functions
        async function loadSettingsTab() {
            loadConfigurationData();
        }

        async function loadConfigurationData() {
            try {
                // Load database stats for configuration
                const statsResponse = await fetch('/api/stats');
                const statsData = await statsResponse.json();
                
                if (statsData.success) {
                    const stats = statsData.stats;
                    document.getElementById('config-database').textContent = stats.database;
                    document.getElementById('config-environment').textContent = 'Production'; // Based on endpoint
                }
                
                // Storage info can be added later if needed
                
            } catch (error) {
                console.error('Error loading configuration:', error);
                document.getElementById('config-database').textContent = 'Error loading';
                document.getElementById('config-environment').textContent = 'Error loading';
                document.getElementById('config-storage').textContent = 'Error loading';
            }
        }

        function backupSystem() {
            // Get real container count for backup
            fetch('/api/containers')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const containerCount = data.containers.length;
                        const totalItems = data.containers.reduce((sum, container) => sum + container.count, 0);
                        alert(`Backup would include ${containerCount} containers with ${totalItems.toLocaleString()} total items`);
                    }
                })
                .catch(error => {
                    console.error('Error getting backup info:', error);
                    alert('Could not determine backup scope');
                });
        }

        function validateConfig() {
            // Run actual validation using system health
            fetch('/api/live/system-health')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const health = data.health;
                        let issues = health.issues || [];
                        
                        if (issues.length === 0) {
                            alert('‚úÖ Configuration validation passed!\nAll systems operational.');
                        } else {
                            alert(`‚ö†Ô∏è Configuration issues found:\n${issues.join('\n')}`);
                        }
                    }
                })
                .catch(error => {
                    console.error('Error validating config:', error);
                    alert('‚ùå Configuration validation failed');
                });
        }

        function restartServices() {
            if (confirm('Are you sure you want to restart services? This may cause temporary downtime.')) {
                // Show real service status
                alert('üîÑ Service restart would affect:\n- Flask API Server\n- Cosmos DB connections\n- Memory layer cache\n- Agent context storage');
            }
        }

        // Load real data for header statistics
        async function loadHeaderStats() {
            try {
                console.log('üì° Fetching /api/live/system-health...');
                // Load system health for header
                const healthResponse = await fetch('/api/live/system-health');
                console.log('üì° Response received:', healthResponse.status, healthResponse.statusText);
                const healthData = await healthResponse.json();
                console.log('üì° Data parsed:', healthData);
                
                if (healthData.success) {
                    const health = healthData.health;
                    const statusElement = document.getElementById('header-system-status');
                    
                    if (health.overall_status === 'healthy') {
                        statusElement.className = 'status-indicator status-online';
                        statusElement.innerHTML = '<span class="pulse"></span>Operational';
                    } else {
                        statusElement.className = 'status-indicator status-warning';
                        statusElement.innerHTML = '<span class="pulse"></span>Degraded';
                    }
                }
                
                // Load agents count
                const agentsResponse = await fetch('/api/live/agents');
                const agentsData = await agentsResponse.json();
                
                if (agentsData.success) {
                    const activeCount = agentsData.agents.filter(agent => 
                        agent.message_stats.status === 'active' || agent.message_stats.status === 'recent'
                    ).length;
                    document.getElementById('header-active-agents').textContent = `${activeCount}/${agentsData.agents.length}`;
                }
                
                // Cost analysis removed - not needed for this dashboard
                
            } catch (error) {
                console.error('Error loading header stats:', error);
                console.error('Error details:', {
                    message: error.message,
                    stack: error.stack,
                    type: error.name
                });
                // Try a simple test fetch
                console.log('üß™ Testing basic fetch...');
                fetch('/api/stats')
                    .then(r => console.log('‚úÖ Basic fetch works:', r.status))
                    .catch(e => console.error('‚ùå Basic fetch failed:', e));
            }
        }

        // Load real data for system health overview
        async function loadSystemHealthOverview() {
            try {
                const healthResponse = await fetch('/api/live/system-health');
                const healthData = await healthResponse.json();
                
                if (healthData.success) {
                    const health = healthData.health;
                    
                    // Cosmos DB status
                    const cosmosElement = document.getElementById('cosmos-status');
                    if (health.cosmos_db.connected) {
                        cosmosElement.className = 'meta-value status-indicator status-online';
                        cosmosElement.innerHTML = '<span class="pulse"></span>Connected';
                    } else {
                        cosmosElement.className = 'meta-value status-indicator status-offline';
                        cosmosElement.innerHTML = '<span class="pulse"></span>Disconnected';
                    }
                    
                    // Get inbox count and total items from stats
                    const statsResponse = await fetch('/api/stats');
                    const statsData = await statsResponse.json();
                    
                    if (statsData.success) {
                        const stats = statsData.stats;
                        
                        // System inbox count
                        const inboxCount = stats.containers.system_inbox || 0;
                        document.getElementById('inbox-count').textContent = `${inboxCount.toLocaleString()} messages`;
                        
                        // Total items
                        document.getElementById('total-items').textContent = `${stats.totalDocuments.toLocaleString()} items`;
                    }
                }
                
            } catch (error) {
                console.error('Error loading system health overview:', error);
                document.getElementById('cosmos-status').innerHTML = 'Error loading';
                document.getElementById('inbox-count').textContent = 'Error loading';
                document.getElementById('total-items').textContent = 'Error loading';
            }
        }

        // Load real data for performance metrics
        async function loadPerformanceMetrics() {
            try {
                const statsResponse = await fetch('/api/stats');
                const statsData = await statsResponse.json();
                
                if (statsData.success) {
                    const stats = statsData.stats;
                    
                    // Container count
                    const containerCount = Object.keys(stats.containers).length;
                    document.getElementById('container-count').textContent = `${containerCount} containers`;
                    
                    // Total documents
                    document.getElementById('storage-size').textContent = `${stats.totalDocuments} documents`;
                    
                    // Database info
                    document.getElementById('ru-usage').textContent = stats.database.split('-')[0];
                }
                
            } catch (error) {
                console.error('Error loading performance metrics:', error);
                document.getElementById('container-count').textContent = 'Error loading';
                document.getElementById('storage-size').textContent = 'Error loading';
                document.getElementById('ru-usage').textContent = 'Error loading';
            }
        }

        // Initialize with progressive loading
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ Dashboard initializing with progressive loading...');
            console.log('üìç Functions available:', {
                loadHeaderStats: typeof loadHeaderStats,
                loadSystemHealthOverview: typeof loadSystemHealthOverview,
                loadPerformanceMetrics: typeof loadPerformanceMetrics
            });
            
            // Simple fetch test
            console.log('üß™ Testing fetch directly...');
            fetch('/api/stats')
                .then(r => {
                    console.log('‚úÖ Direct fetch success:', r.status);
                    return r.json();
                })
                .then(d => console.log('‚úÖ Data:', d))
                .catch(e => console.error('‚ùå Direct fetch error:', e));
            
            console.log('üìç Starting loadHeaderStats...');
            
            // HONEST TEST: Load one function at a time to see where it breaks
            console.log('üîç Testing loadHeaderStats...');
            loadHeaderStats().then(() => {
                console.log('‚úÖ loadHeaderStats completed successfully');
                
                console.log('üîç Testing loadSystemHealthOverview...');
                return loadSystemHealthOverview();
            }).then(() => {
                console.log('‚úÖ loadSystemHealthOverview completed successfully');
                
                console.log('üîç Testing loadPerformanceMetrics...');
                return loadPerformanceMetrics();
            }).then(() => {
                console.log('‚úÖ loadPerformanceMetrics completed successfully');
                console.log('‚úÖ ALL FUNCTIONS COMPLETED - Dashboard should be working');
            }).catch(error => {
                console.error('‚ùå FAILED at function:', error);
                console.error('‚ùå Full error details:', error.stack || error);
            });
            
            // Initialize character counter
            const textarea = document.getElementById('session-log-content');
            if (textarea) {
                textarea.addEventListener('input', updateCharCount);
            }
            
            // Refresh data every 60 seconds (staggered) to prevent overlapping
            setInterval(() => {
                // Only refresh if not already loading
                if (!window.isRefreshing) {
                    window.isRefreshing = true;
                    loadHeaderStats();
                    setTimeout(() => loadSystemHealthOverview(), 2000);
                    setTimeout(() => loadPerformanceMetrics(), 4000);
                    setTimeout(() => loadActiveAgents(), 8000);
                    setTimeout(() => loadCoreDocuments(), 10000);
                    // Reset flag after all loads complete
                    setTimeout(() => { window.isRefreshing = false; }, 15000);
                }
            }, 60000);
        });
        
        // Session Log Upload Functions
        async function saveSessionLog() {
            const agentName = document.getElementById('agent-selector').value;
            const logContent = document.getElementById('session-log-content').value;
            const storeInCosmos = document.getElementById('store-cosmos').checked;
            
            if (!agentName) {
                alert('Please select an agent first');
                return;
            }
            
            if (!logContent.trim()) {
                alert('Please paste the session log content');
                return;
            }
            
            // Show loading status
            showLogSaveStatus('Saving session log...', 'loading');
            
            try {
                const response = await fetch('/api/logs/save-session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        agent_name: agentName,
                        log_content: logContent,
                        store_in_cosmos: storeInCosmos
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const text = await response.text();
                let data;
                try {
                    data = JSON.parse(text);
                } catch (e) {
                    console.error('Failed to parse response:', text);
                    throw new Error('Invalid response from server');
                }
                
                if (data.success) {
                    let cosmosStatus = data.cosmos_stored ? '‚úÖ Stored' : '‚ùå Not stored';
                    let storageInfo = '';
                    let additionalInfo = '';
                    
                    // Determine storage location display
                    if (data.storage_type === 'blob') {
                        storageInfo = `<div>‚òÅÔ∏è Azure Blob: ‚úÖ Stored</div>`;
                        if (data.blob_url) {
                            storageInfo += `<div style="font-size: 0.75rem; margin-left: 1.5rem;">
                                <a href="${data.blob_url}" target="_blank" style="color: var(--accent-cyan);">View in Azure</a>
                            </div>`;
                        }
                    } else if (data.storage_type === 'cosmos') {
                        storageInfo = `<div>üí´ Storage: Full content in Cosmos DB</div>`;
                    } else {
                        storageInfo = `<div>üìÅ Storage: Local only</div>`;
                    }
                    
                    if (data.cosmos_note) {
                        additionalInfo = `<div style="color: var(--warning-amber);">üìù Note: ${data.cosmos_note}</div>`;
                    } else if (data.cosmos_error) {
                        additionalInfo = `<div style="color: var(--danger-red);">‚ö†Ô∏è Error: ${data.cosmos_error}</div>`;
                    }
                    
                    showLogSaveStatus(`
                        <div style="color: var(--success-green); font-weight: 500;">‚úÖ Session Log Saved!</div>
                        <div style="margin-top: 0.5rem; font-size: 0.875rem;">
                            <div>üìú Agent: ${data.agent_name}</div>
                            <div>üìÑ File: ${data.filename}</div>
                            <div>üíæ Local path: ${data.local_path}</div>
                            <div>üåç Cosmos DB: ${cosmosStatus}</div>
                            ${storageInfo}
                            <div>üìÖ Size: ${(data.size_kb).toFixed(1)} KB</div>
                            ${additionalInfo}
                        </div>
                    `, 'success');
                    
                    // Clear the form after successful save
                    document.getElementById('session-log-content').value = '';
                    updateCharCount();
                } else {
                    showLogSaveStatus(`‚ùå Error: ${data.error}`, 'error');
                }
            } catch (error) {
                console.error('Error saving session log:', error);
                showLogSaveStatus(`‚ùå Save failed: ${error.message}`, 'error');
            }
        }
        
        function clearLogForm() {
            document.getElementById('agent-selector').value = '';
            document.getElementById('session-log-content').value = '';
            document.getElementById('store-cosmos').checked = true;
            updateCharCount();
            
            // Hide status
            document.getElementById('log-save-status').style.display = 'none';
        }
        
        function updateCharCount() {
            const content = document.getElementById('session-log-content').value;
            const charCount = content.length;
            document.getElementById('char-count').textContent = charCount.toLocaleString();
        }
        
        function showLogSaveStatus(message, type) {
            const statusDiv = document.getElementById('log-save-status');
            const contentDiv = document.getElementById('log-save-content');
            
            statusDiv.style.display = 'block';
            contentDiv.innerHTML = message;
            
            // Style based on type
            if (type === 'loading') {
                statusDiv.style.borderColor = 'var(--accent-cyan)';
                statusDiv.style.background = 'rgba(6, 182, 212, 0.1)';
            } else if (type === 'success') {
                statusDiv.style.borderColor = 'var(--success-green)';
                statusDiv.style.background = 'rgba(16, 185, 129, 0.1)';
            } else if (type === 'error') {
                statusDiv.style.borderColor = 'var(--danger-red)';
                statusDiv.style.background = 'rgba(239, 68, 68, 0.1)';
            }
            
            // Auto-hide after 10 seconds for success/error
            if (type !== 'loading') {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 10000);
            }
        }
        
        // Initialize character counter
        document.addEventListener('DOMContentLoaded', function() {
            const textarea = document.getElementById('session-log-content');
            if (textarea) {
                textarea.addEventListener('input', updateCharCount);
            }
        });

        // Functions to handle remaining loading elements
        async function loadSystemHealthDetails() {
            try {
                const content = document.getElementById('system-health-content');
                if (content) {
                    content.innerHTML = `
                        <div class="grid" style="gap: 0.75rem;">
                            <div class="meta-item">
                                <span class="meta-label">System Status</span>
                                <span class="meta-value" style="color: var(--success-green);">Operational</span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-label">Database</span>
                                <span class="meta-value" style="color: var(--success-green);">Connected</span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-label">APIs</span>
                                <span class="meta-value" style="color: var(--success-green);">Responding</span>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('System health details error:', error);
            }
        }

        async function loadDocumentationBrowser() {
            try {
                const content = document.getElementById('docs-browser-content');
                if (content) {
                    content.innerHTML = `
                        <div class="grid" style="gap: 0.75rem;">
                            <div class="meta-item">
                                <span class="meta-label">Documentation</span>
                                <span class="meta-value">Available</span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-label">Core Documents</span>
                                <span class="meta-value">6 found</span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-label">Status</span>
                                <span class="meta-value" style="color: var(--success-green);">Ready</span>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Documentation browser error:', error);
            }
        }

        // Graph Explorer Functions
        let graphInstance = null;
        let advancedGraphEngine = null; // Disabled - script not loaded
        let simpleGraphRenderer = null;
        let graphData = { nodes: [], edges: [] };
        let isUpgradingGraph = false;

        async function loadGraphTab() {
            console.log('üìà Loading Graph Explorer tab...');
            
            // Make sure the tab content is visible
            const graphTab = document.getElementById('graph-tab');
            if (!graphTab || !graphTab.classList.contains('active')) {
                console.error('‚ùå Graph tab not active or not found');
                return;
            }
            
            // Progressive enhancement strategy
            if (!graphInstance && !advancedGraphEngine && !simpleGraphRenderer) {
                console.log('üîß Initializing graph with progressive enhancement...');
                
                // Step 1: Load simple renderer immediately if Cytoscape is available
                if (typeof cytoscape !== 'undefined') {
                    initializeSimpleGraph();
                    refreshGraph();
                    
                    // Step 2: Upgrade to advanced renderer when available
                    scheduleAdvancedGraphUpgrade();
                } else {
                    // Wait for Cytoscape first
                    waitForCytoscape();
                }
            } else if (advancedGraphEngine) {
                console.log('‚ôªÔ∏è Advanced graph engine already exists');
                refreshGraph();
            } else if (simpleGraphRenderer || graphInstance) {
                console.log('‚ôªÔ∏è Graph renderer exists, refreshing...');
                refreshGraph();
            }
        }
        
        function initializeSimpleGraph() {
            try {
                console.log('‚ö° Initializing simple graph renderer for fast display...');
                
                // Load simple renderer script if not already loaded
                if (typeof SimpleGraphRenderer === 'undefined') {
                    const script = document.createElement('script');
                    script.src = '/static/graph-simple.js';
                    script.onload = () => {
                        createSimpleRenderer();
                    };
                    document.head.appendChild(script);
                } else {
                    createSimpleRenderer();
                }
            } catch (error) {
                console.error('‚ùå Failed to initialize simple graph:', error);
                initializeGraph(); // Fallback to standard
            }
        }
        
        function createSimpleRenderer() {
            simpleGraphRenderer = new SimpleGraphRenderer('graph-container');
            if (simpleGraphRenderer.initialize()) {
                console.log('‚úÖ Simple graph renderer ready');
                graphInstance = simpleGraphRenderer.cy; // Compatibility
            }
        }
        
        function scheduleAdvancedGraphUpgrade() {
            // Use requestIdleCallback for non-blocking upgrade
            const upgradeToAdvanced = () => {
                if (isUpgradingGraph) return;
                
                const checkAndUpgrade = () => {
                    if (false) { // AdvancedGraphEngine disabled
                        console.log('üöÄ Upgrading to advanced graph engine...');
                        isUpgradingGraph = true;
                        
                        // Save current data
                        const currentData = graphData.elements;
                        
                        // Destroy simple renderer
                        if (simpleGraphRenderer) {
                            simpleGraphRenderer.destroy();
                            simpleGraphRenderer = null;
                        }
                        
                        // Initialize advanced engine
                        initializeAdvancedGraph().then(() => {
                            // Reload data if available
                            if (currentData && currentData.length > 0) {
                                advancedGraphEngine.loadGraph(currentData);
                            }
                            isUpgradingGraph = false;
                        });
                    } else {
                        // Check again later
                        setTimeout(checkAndUpgrade, 1000);
                    }
                };
                
                checkAndUpgrade();
            };
            
            if ('requestIdleCallback' in window) {
                requestIdleCallback(upgradeToAdvanced, { timeout: 5000 });
            } else {
                setTimeout(upgradeToAdvanced, 2000);
            }
        }
        
        function waitForCytoscape() {
            let attempts = 0;
            function checkCytoscape() {
                attempts++;
                if (typeof cytoscape !== 'undefined') {
                    console.log('‚úÖ Cytoscape loaded');
                    initializeSimpleGraph();
                    refreshGraph();
                    scheduleAdvancedGraphUpgrade();
                } else if (attempts < 50) {
                    setTimeout(checkCytoscape, 100);
                } else {
                    console.error('‚ùå Timeout waiting for Cytoscape');
                    showGraphError('Graph library failed to load. Please refresh the page.');
                }
            }
            checkCytoscape();
        }
        
        async function initializeAdvancedGraph() {
            try {
                console.log('üöÄ Initializing Advanced Graph Engine...');
                
                // Add performance indicator
                const container = document.getElementById('graph-container');
                const perfIndicator = document.createElement('div');
                perfIndicator.className = 'graph-performance-indicator';
                perfIndicator.innerHTML = 'FPS: <span id="fps-counter">60</span>';
                container.parentElement.style.position = 'relative';
                container.parentElement.appendChild(perfIndicator);
                
                // Advanced engine disabled - files not found
                // advancedGraphEngine = new AdvancedGraphEngine('graph-container');
                // await advancedGraphEngine.initialize();
                
                /* Disabled FPS counter
                // Update FPS counter
                setInterval(() => {
                    const stats = advancedGraphEngine.getStatistics();
                    document.getElementById('fps-counter').textContent = stats.fps;
                    
                    // Update indicator color based on FPS
                    if (stats.fps >= 50) {
                        perfIndicator.className = 'graph-performance-indicator good';
                    } else if (stats.fps >= 30) {
                        perfIndicator.className = 'graph-performance-indicator warning';
                    } else {
                        perfIndicator.className = 'graph-performance-indicator poor';
                    }
                }, 1000);
                */
                console.log('‚úÖ Advanced Graph Engine initialized!');
                refreshGraph();
                
            } catch (error) {
                console.error('‚ùå Failed to initialize advanced graph:', error);
                // Fallback to standard graph
                initializeGraph();
            }
        }

        function initializeGraph() {
            console.log('üîç Looking for graph container...');
            const container = document.getElementById('graph-container');
            if (!container) {
                console.error('‚ùå Graph container not found!');
                showGraphError('Graph container element not found.');
                return;
            }
            console.log('‚úÖ Graph container found:', container);

            // Check if Cytoscape is loaded
            if (typeof cytoscape === 'undefined') {
                console.error('‚ùå Cytoscape library not loaded');
                showGraphError('Graph library not loaded. Please refresh the page.');
                return;
            }
            console.log('‚úÖ Cytoscape library is available');

            // Cytoscape configuration
            try {
                console.log('üîß Creating Cytoscape instance...');
                graphInstance = cytoscape({
                    container: container,
                    style: [
                    // Node styles based on type
                    {
                        selector: 'node',
                        style: {
                            'background-color': 'data(color)',
                            'label': 'data(name)',
                            'text-valign': 'center',
                            'text-halign': 'center',
                            'color': '#ffffff',
                            'text-outline-width': 3,
                            'text-outline-color': '#000000',
                            'font-size': '14px',
                            'font-weight': 'bold',
                            'width': 'mapData(importance, 0, 1, 40, 80)',
                            'height': 'mapData(importance, 0, 1, 40, 80)',
                            'border-width': 3,
                            'border-color': '#ffffff',
                            'overlay-padding': 4
                        }
                    },
                    // Research Document nodes
                    {
                        selector: 'node[type="ResearchDocument"]',
                        style: {
                            'background-color': '#60a5fa',
                            'shape': 'rectangle',
                            'width': 80,
                            'height': 50,
                            'font-size': '16px'
                        }
                    },
                    // Research Concept nodes
                    {
                        selector: 'node[type="ResearchConcept"]',
                        style: {
                            'background-color': '#34d399',
                            'shape': 'ellipse',
                            'font-size': '15px'
                        }
                    },
                    // Author nodes
                    {
                        selector: 'node[type="Author"]',
                        style: {
                            'background-color': '#fbbf24',
                            'shape': 'triangle',
                            'font-size': '14px'
                        }
                    },
                    // Methodology nodes
                    {
                        selector: 'node[type="Methodology"]',
                        style: {
                            'background-color': '#a78bfa',
                            'shape': 'diamond',
                            'font-size': '14px'
                        }
                    },
                    // Edge styles
                    {
                        selector: 'edge',
                        style: {
                            'curve-style': 'bezier',
                            'target-arrow-shape': 'triangle',
                            'target-arrow-color': 'data(color)',
                            'line-color': 'data(color)',
                            'width': 'mapData(strength, 0, 1, 2, 6)',
                            'label': 'data(label)',
                            'font-size': '12px',
                            'text-rotation': 'autorotate',
                            'color': '#ffffff',
                            'text-outline-width': 2,
                            'text-outline-color': '#000000'
                        }
                    },
                    // Edge types with brighter colors
                    {
                        selector: 'edge[type="CONTAINS_CONCEPT"]',
                        style: { 'line-color': '#22d3ee', 'target-arrow-color': '#22d3ee' }
                    },
                    {
                        selector: 'edge[type="CITES"]',
                        style: { 'line-color': '#f87171', 'target-arrow-color': '#f87171' }
                    },
                    {
                        selector: 'edge[type="AUTHORED_BY"]',
                        style: { 'line-color': '#fbbf24', 'target-arrow-color': '#fbbf24' }
                    },
                    // Selected node
                    {
                        selector: 'node:selected',
                        style: {
                            'border-width': 5,
                            'border-color': '#22d3ee',
                            'overlay-color': '#22d3ee',
                            'overlay-opacity': 0.3,
                            'z-index': 999
                        }
                    },
                    // Highlighted nodes (for search)
                    {
                        selector: 'node.highlighted',
                        style: {
                            'border-width': 5,
                            'border-color': '#fbbf24',
                            'overlay-color': '#fbbf24',
                            'overlay-opacity': 0.3
                        }
                    }
                ],
                layout: {
                    name: 'circle',  // Use simple circle layout initially
                    animate: false
                },
                elements: [],
                minZoom: 0.2,
                maxZoom: 3,
                wheelSensitivity: 0.1
            });

            // Event handlers
            graphInstance.on('tap', 'node', function(evt) {
                const node = evt.target;
                selectNode(node);
                showNodeDetails(node.data());
            });

            graphInstance.on('tap', function(evt) {
                if (evt.target === graphInstance) {
                    clearNodeSelection();
                }
            });

            console.log('‚úÖ Graph instance created successfully!');
            console.log('Graph instance type:', typeof graphInstance);
            console.log('Graph instance exists:', !!graphInstance);
            
            } catch (error) {
                console.error('‚ùå Error creating graph instance:', error);
                graphInstance = null;
                showGraphError(`Failed to create graph: ${error.message}`);
            }
        }

        async function refreshGraph() {
            try {
                console.log('üîÑ Starting graph refresh...');
                showGraphLoading(true);
                
                const domain = document.getElementById('domain-filter').value;
                const params = new URLSearchParams();
                if (domain) params.append('domain', domain);
                params.append('node_limit', '50');
                params.append('edge_limit', '100');

                console.log('üåê Fetching graph data from:', `/api/graph/full?${params}`);
                const response = await fetch(`/api/graph/full?${params}`);
                const data = await response.json();

                console.log('üì¶ Raw API response:', data);

                if (data.success) {
                    graphData = data;
                    console.log('üìä Elements to visualize:', data.elements?.length || 0);
                    console.log('üîç Sample element:', data.elements?.[0]);
                    
                    if (!data.elements || data.elements.length === 0) {
                        console.warn('‚ö†Ô∏è No elements returned for current filter');
                        showGraphError('No data available for the selected filter. Try "All Domains".');
                    } else {
                        // Use standard visualization
                        updateGraphVisualization(data.elements);
                        updateGraphStats(data.stats);
                        console.log('‚úÖ Graph data loaded successfully:', data.stats);
                    }
                } else {
                    console.error('‚ùå Graph API error:', data.error);
                    showGraphError(`Failed to load graph: ${data.error}`);
                }
            } catch (error) {
                console.error('‚ùå Graph refresh error:', error);
                showGraphError('Failed to connect to graph database');
            } finally {
                showGraphLoading(false);
            }
        }

        function updateGraphVisualization(elements) {
            console.log('üé® Starting visualization update...');
            console.log('üìä Graph instance exists:', !!graphInstance);
            console.log('üì¶ Elements received:', elements?.length || 0);
            
            if (!graphInstance) {
                console.error('‚ùå No graph instance available');
                return;
            }

            // Clear existing elements
            console.log('üßπ Clearing existing elements...');
            graphInstance.elements().remove();
            
            // Add new elements
            if (elements && elements.length > 0) {
                console.log('‚ûï Adding elements to graph:', elements.length);
                console.log('üîç Sample elements:', elements.slice(0, 3));
                
                try {
                    // Separate nodes and edges
                    const nodes = elements.filter(el => !el.data.source);
                    const edges = elements.filter(el => el.data.source);
                    
                    // Create a set of valid node IDs
                    const nodeIds = new Set(nodes.map(node => node.data.id));
                    
                    // Filter edges to only include those with valid source and target
                    const validEdges = edges.filter(edge => {
                        const hasValidSource = nodeIds.has(edge.data.source);
                        const hasValidTarget = nodeIds.has(edge.data.target);
                        
                        if (!hasValidSource || !hasValidTarget) {
                            console.warn(`‚ö†Ô∏è Skipping edge ${edge.data.id}: missing ${!hasValidSource ? 'source' : 'target'} node`);
                            return false;
                        }
                        return true;
                    });
                    
                    console.log(`‚úÖ Valid nodes: ${nodes.length}, Valid edges: ${validEdges.length} (skipped ${edges.length - validEdges.length} invalid edges)`);
                    
                    // Add nodes first, then edges
                    graphInstance.add(nodes);
                    graphInstance.add(validEdges);
                    console.log('‚úÖ Elements added successfully');
                    
                    // Apply current layout
                    const layoutName = document.getElementById('graph-layout').value;
                    console.log('üéØ Applying layout:', layoutName);
                    changeGraphLayout(layoutName, false);
                    
                    // Resize and fit to view
                    setTimeout(() => {
                        console.log('üîç Resizing and fitting graph to view...');
                        graphInstance.resize();
                        graphInstance.fit(null, 50);
                        console.log('‚úÖ Graph visualization complete');
                    }, 500);
                } catch (error) {
                    console.error('‚ùå Error adding elements to graph:', error);
                    showGraphError(`Visualization error: ${error.message}`);
                }
            } else {
                console.warn('‚ö†Ô∏è No elements to display');
                showGraphError('No graph data available');
            }
        }

        function changeGraphLayout(layoutName = null, animate = true) {
            if (!graphInstance) return;
            
            const layout = layoutName || document.getElementById('graph-layout').value;
            console.log('üéØ Changing to layout:', layout);
            
            const layoutConfigs = {
                'circle': {
                    name: 'circle',
                    animate: animate,
                    animationDuration: animate ? 800 : 0
                },
                'grid': {
                    name: 'grid',
                    animate: animate,
                    animationDuration: animate ? 800 : 0,
                    rows: 5
                },
                'breadthfirst': {
                    name: 'breadthfirst',
                    animate: animate,
                    animationDuration: animate ? 800 : 0,
                    directed: true,
                    spacingFactor: 1.2
                },
                'concentric': {
                    name: 'concentric',
                    animate: animate,
                    animationDuration: animate ? 800 : 0,
                    concentric: function(node) {
                        return node.degree();
                    },
                    levelWidth: function(nodes) {
                        return 2;
                    }
                },
                'cose-bilkent': {
                    name: 'cose-bilkent',
                    animate: animate,
                    animationDuration: animate ? 1000 : 0,
                    nodeRepulsion: 4500,
                    idealEdgeLength: 50,
                    edgeElasticity: 0.45
                }
            };

            const layoutConfig = layoutConfigs[layout] || layoutConfigs['circle'];
            
            try {
                console.log('üîß Applying layout config:', layoutConfig);
                const layoutInstance = graphInstance.layout(layoutConfig);
                layoutInstance.run();
                console.log('‚úÖ Layout applied successfully');
            } catch (error) {
                console.error('‚ùå Layout error:', error);
                // Fallback to simple circle layout
                console.log('üîÑ Falling back to circle layout...');
                graphInstance.layout({ name: 'circle' }).run();
            }
        }

        function resetGraphView() {
            if (!graphInstance) return;
            graphInstance.fit(null, 50);
            graphInstance.zoom(1);
            graphInstance.center();
        }

        function filterByDomain() {
            refreshGraph();
        }

        function toggleNodeType(nodeType) {
            if (!graphInstance) return;
            
            const checkbox = document.getElementById(`show-${nodeType.toLowerCase().replace('research', '')}`);
            const isVisible = checkbox.checked;
            
            graphInstance.nodes(`[type="${nodeType}"]`).style('display', isVisible ? 'element' : 'none');
        }

        function searchNodes() {
            const searchTerm = document.getElementById('node-search').value.toLowerCase();
            
            if (!graphInstance || !searchTerm) {
                // Reset all nodes to visible
                graphInstance.nodes().removeClass('dimmed');
                return;
            }
            
            // Dim all nodes first
            graphInstance.nodes().addClass('dimmed');
            
            // Highlight matching nodes
            graphInstance.nodes().forEach(node => {
                const data = node.data();
                const name = (data.name || '').toLowerCase();
                const title = (data.title || '').toLowerCase();
                const id = (data.id || '').toLowerCase();
                
                if (name.includes(searchTerm) || title.includes(searchTerm) || id.includes(searchTerm)) {
                    node.removeClass('dimmed');
                }
            });
        }

        function selectNode(node) {
            if (!graphInstance) return;
            
            // Clear previous selection
            graphInstance.nodes().removeClass('highlighted');
            
            // Highlight selected node and its neighbors
            node.addClass('highlighted');
            node.neighborhood().addClass('highlighted');
            
            // Update selection count
            document.getElementById('selected-count').textContent = '1 node';
        }

        function clearNodeSelection() {
            if (!graphInstance) return;
            
            graphInstance.nodes().removeClass('highlighted');
            document.getElementById('selected-count').textContent = 'None';
            
            // Clear node details
            document.getElementById('node-details').innerHTML = `
                <div style="text-align: center; padding: 2rem; color: var(--text-muted);">
                    Click on a node to view details
                </div>
            `;
        }

        function showNodeDetails(nodeData) {
            const details = document.getElementById('node-details');
            
            const html = `
                <div style="padding: 1rem;">
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--border-color);">
                        <span style="font-size: 1.2rem;">${getNodeIcon(nodeData.type)}</span>
                        <h4 style="color: var(--accent-cyan); margin: 0;">${nodeData.name || nodeData.id}</h4>
                    </div>
                    
                    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                        <div>
                            <span style="color: var(--text-secondary); font-size: 0.8rem; text-transform: uppercase;">Type</span>
                            <div style="color: var(--text-primary);">${nodeData.type || 'Unknown'}</div>
                        </div>
                        
                        ${nodeData.domain ? `
                        <div>
                            <span style="color: var(--text-secondary); font-size: 0.8rem; text-transform: uppercase;">Domain</span>
                            <div style="color: var(--text-primary);">${nodeData.domain}</div>
                        </div>
                        ` : ''}
                        
                        ${nodeData.title ? `
                        <div>
                            <span style="color: var(--text-secondary); font-size: 0.8rem; text-transform: uppercase;">Title</span>
                            <div style="color: var(--text-primary); font-size: 0.9rem;">${nodeData.title}</div>
                        </div>
                        ` : ''}
                        
                        ${nodeData.complexity !== undefined ? `
                        <div>
                            <span style="color: var(--text-secondary); font-size: 0.8rem; text-transform: uppercase;">Complexity</span>
                            <div style="color: var(--text-primary);">${(nodeData.complexity * 100).toFixed(1)}%</div>
                        </div>
                        ` : ''}
                        
                        ${nodeData.frequency ? `
                        <div>
                            <span style="color: var(--text-secondary); font-size: 0.8rem; text-transform: uppercase;">Frequency</span>
                            <div style="color: var(--text-primary);">${nodeData.frequency}</div>
                        </div>
                        ` : ''}
                        
                        ${nodeData.importance !== undefined ? `
                        <div>
                            <span style="color: var(--text-secondary); font-size: 0.8rem; text-transform: uppercase;">Importance</span>
                            <div style="color: var(--text-primary);">${(nodeData.importance * 100).toFixed(1)}%</div>
                        </div>
                        ` : ''}
                        
                        <div>
                            <span style="color: var(--text-secondary); font-size: 0.8rem; text-transform: uppercase;">Node ID</span>
                            <div style="color: var(--text-muted); font-family: monospace; font-size: 0.8rem;">${nodeData.id}</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                        <button class="btn btn-secondary" onclick="findNodeNeighbors('${nodeData.id}')" style="width: 100%; font-size: 0.8rem;">
                            üîç Find Neighbors
                        </button>
                    </div>
                </div>
            `;
            
            details.innerHTML = html;
        }

        function getNodeIcon(nodeType) {
            const icons = {
                'ResearchDocument': 'üìÑ',
                'ResearchConcept': 'üí°',
                'Author': 'üë§',
                'Methodology': 'üî¨',
                'Topic': 'üè∑Ô∏è'
            };
            return icons[nodeType] || '‚ö™';
        }

        async function findNodeNeighbors(nodeId) {
            try {
                const response = await fetch(`/api/graph/neighbors/${nodeId}`);
                const data = await response.json();
                
                if (data.success) {
                    console.log(`Found ${data.count} neighbors for node ${nodeId}:`, data.neighbors);
                    // TODO: Highlight neighbors in graph
                } else {
                    console.error('Failed to get neighbors:', data.error);
                }
            } catch (error) {
                console.error('Error finding neighbors:', error);
            }
        }

        function updateGraphStats(stats) {
            if (stats) {
                document.getElementById('node-count').textContent = stats.node_count || 0;
                document.getElementById('edge-count').textContent = stats.edge_count || 0;
            }
        }

        function showGraphLoading(show) {
            const loading = document.getElementById('graph-loading');
            if (loading) {
                loading.style.display = show ? 'block' : 'none';
            }
        }

        function showGraphError(message) {
            const container = document.getElementById('graph-container');
            if (container) {
                container.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-muted); flex-direction: column; gap: 1rem;">
                        <div style="font-size: 2rem;">‚ö†Ô∏è</div>
                        <div>${message}</div>
                        <button class="btn btn-primary" onclick="refreshGraph()">Retry</button>
                    </div>
                `;
            }
        }

        // Add dimmed style for search
        const searchStyle = document.createElement('style');
        searchStyle.textContent = `
            .cy-node.dimmed {
                opacity: 0.3 !important;
            }
            .cy-node.highlighted {
                opacity: 1 !important;
            }
        `;
        document.head.appendChild(searchStyle);

        // Server Management Functions
        async function restartServer() {
            if (!confirm('üîÑ Are you sure you want to restart the server?\n\nThis will briefly interrupt all dashboard functions.')) {
                return;
            }

            const button = event.target.closest('button');
            const originalText = button.innerHTML;
            
            try {
                // Update button state
                button.innerHTML = '<span>‚è≥</span>Restarting...';
                button.disabled = true;
                
                // Update server status
                document.getElementById('server-status').innerHTML = '<span class="pulse" style="background: var(--warning-amber);"></span>Restarting...';
                document.getElementById('server-status').className = 'meta-value status-indicator status-warning';
                
                // Create a backend API endpoint for server restart
                const response = await fetch('/api/system/restart', { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (response.ok) {
                    // Show success and wait for server to come back
                    button.innerHTML = '<span>‚úÖ</span>Restarted';
                    
                    // Wait a bit then try to reconnect
                    setTimeout(async () => {
                        try {
                            const healthCheck = await fetch('/api/stats');
                            if (healthCheck.ok) {
                                button.innerHTML = originalText;
                                button.disabled = false;
                                document.getElementById('server-status').innerHTML = '<span class="pulse"></span>Running';
                                document.getElementById('server-status').className = 'meta-value status-indicator status-online';
                                alert('‚úÖ Server restarted successfully!');
                            }
                        } catch (e) {
                            // Server might still be starting
                            setTimeout(() => location.reload(), 2000);
                        }
                    }, 3000);
                } else {
                    // Handle the case where restart is disabled
                    const errorData = await response.json();
                    if (errorData.manual_instructions) {
                        button.innerHTML = '<span>‚ö†Ô∏è</span>Manual Restart';
                        button.disabled = false;
                        
                        const instructions = errorData.manual_instructions.join('\n');
                        alert(`‚ö†Ô∏è ${errorData.message}\n\nManual Instructions:\n${instructions}`);
                        
                        document.getElementById('server-status').innerHTML = '<span class="pulse" style="background: var(--warning-amber);"></span>Manual Restart Required';
                        document.getElementById('server-status').className = 'meta-value status-indicator status-warning';
                    } else {
                        throw new Error('Failed to restart server');
                    }
                }
                
            } catch (error) {
                console.error('Restart error:', error);
                button.innerHTML = originalText;
                button.disabled = false;
                document.getElementById('server-status').innerHTML = '<span class="pulse" style="background: var(--danger-red);"></span>Error';
                document.getElementById('server-status').className = 'meta-value status-indicator status-error';
                alert('‚ùå Failed to restart server. Check console for details.');
            }
        }

        async function reloadFrontend() {
            if (!confirm('üåê Reload the frontend?\n\nThis will refresh the page with the latest version.')) {
                return;
            }
            
            // Add cache-busting parameter
            const url = new URL(window.location);
            url.searchParams.set('t', Date.now());
            window.location.href = url.toString();
        }

        async function clearServerCache() {
            if (!confirm('üßπ Clear server cache?\n\nThis will clear any cached data on the server side.')) {
                return;
            }

            const button = event.target.closest('button');
            const originalText = button.innerHTML;
            
            try {
                button.innerHTML = '<span>‚è≥</span>Clearing...';
                button.disabled = true;
                
                // This could call a backend endpoint to clear server-side cache
                const response = await fetch('/api/system/clear-cache', { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (response.ok) {
                    button.innerHTML = '<span>‚úÖ</span>Cleared';
                    setTimeout(() => {
                        button.innerHTML = originalText;
                        button.disabled = false;
                    }, 2000);
                    alert('‚úÖ Server cache cleared successfully!');
                } else {
                    throw new Error('Failed to clear cache');
                }
                
            } catch (error) {
                console.error('Clear cache error:', error);
                button.innerHTML = originalText;
                button.disabled = false;
                alert('‚ö†Ô∏è Cache clear endpoint not implemented yet.');
            }
        }
        
        // Advanced Graph Control Functions
        function updateGraphQuality(value) {
            if (!advancedGraphEngine) return;
            
            const quality = ['draft', 'default', 'proof'][value - 1];
            console.log(`üé® Setting graph quality to: ${quality}`);
            
            // Re-run layout with new quality
            const currentLayout = document.getElementById('graph-layout').value;
            advancedGraphEngine.cy.layout({
                name: currentLayout,
                quality: quality,
                animate: true
            }).run();
        }
        
        function updateAnimationSpeed(value) {
            if (!advancedGraphEngine) return;
            advancedGraphEngine.animationDuration = parseInt(value);
            console.log(`‚ö° Animation speed set to: ${value}ms`);
        }
        
        function clusterNodes() {
            if (!advancedGraphEngine) return;
            
            // Cluster by domain
            advancedGraphEngine.clusterByAttribute('domain');
        }
        
        function exportGraph() {
            if (advancedGraphEngine) {
                advancedGraphEngine.exportImage('png', 3);
            } else if (graphInstance) {
                const data = graphInstance.png({
                    scale: 3,
                    full: true,
                    bg: '#0f172a'
                });
                
                const link = document.createElement('a');
                link.href = data;
                link.download = `graph-export-${Date.now()}.png`;
                link.click();
            }
        }
        
        function findShortestPath() {
            if (!advancedGraphEngine) return;
            
            const selected = advancedGraphEngine.cy.nodes(':selected');
            if (selected.length === 2) {
                advancedGraphEngine.findPath(selected[0].id(), selected[1].id());
            } else {
                alert('Please select exactly 2 nodes to find the path between them');
            }
        }
    </script>
    
    <!-- Document Viewer Modal -->
    <div id="documentModal" class="modal-overlay" onclick="closeDocumentModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 id="modalTitle">Document Viewer</h3>
                <button class="modal-close" onclick="closeDocumentModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div id="modalContent">
                    <!-- Document content will be inserted here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Floating Action Buttons -->
    <div class="floating-actions">
        <button class="fab" onclick="window.scrollTo({ top: 0, behavior: 'smooth' })" title="Back to Top">
            ‚Üë
        </button>
        <button class="fab" onclick="toggleDarkMode()" title="Toggle Theme">
            üåô
        </button>
        <button class="fab" onclick="showQuickActions()" title="Quick Actions">
            ‚ö°
        </button>
    </div>
    
    <!-- Loading Overlay -->
    <div id="globalLoader" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; align-items: center; justify-content: center;">
        <div style="text-align: center;">
            <div class="graph-loading-spinner"></div>
            <div class="graph-loading-text">Graph Ready</div>
        </div>
    </div>
    
    <script>
        // Enhanced UI Functions
        function toggleDarkMode() {
            // For now, just a placeholder
            console.log('Theme toggle - already in dark mode');
        }
        
        function showQuickActions() {
            // Show quick actions menu
            alert('Quick Actions: Coming soon!');
        }
        
        // Add page load animation - DISABLED due to conflict with dashboard-performance.js
        // This was causing the infinite loading issue
        /*
        window.addEventListener('load', () => {
            document.body.style.opacity = '0';
            document.body.style.transition = 'opacity 0.5s ease';
            setTimeout(() => {
                document.body.style.opacity = '1';
            }, 100);
        });
        */
        
        // Add smooth scrolling for all internal links
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({ behavior: 'smooth' });
                }
            });
        });
    </script>

    <!-- JavaScript libraries now loaded in head with defer attribute -->
    
    <script>
        // Mark libraries as ready after all are loaded
        window.cytoscapeReady = true;
        console.log('‚úÖ All libraries loaded in correct order');
    </script>
</body>
</html>